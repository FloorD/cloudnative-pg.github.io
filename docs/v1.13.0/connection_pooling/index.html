<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="flex flex-row px-16 justify-between py-5">
      <div>
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      <div>
        <ul class="flex gap-14 text-2xl text-slate-400 my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Support</li>
          <li>End users</li>
          <li>Blog</li>
        </ul>
      </div>
      <div class="flex gap-5 my-4">
        <a href="https://github.com/cloudnative-pg/cloudnative-pg">
          <img src="/icons/Git.svg" alt="Github">
        </a>
        <a href="https://cloudnativepg.slack.com/">
          <img src="/icons/Slack.svg" alt="Slack">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>


    
<h2 class="text-2xl"></h2>
<h1 id="connection-pooling">Connection Pooling</h1>
<p>Cloud Native PostgreSQL provides native support for connection pooling with
<a href="https://www.pgbouncer.org/">PgBouncer</a>, one of the most popular open source
connection poolers for PostgreSQL, through the <code>Pooler</code> CRD.</p>
<p>In a nutshell, a <code>Pooler</code> in Cloud Native PostgreSQL is a deployment of
PgBouncer pods that sits between your applications and a PostgreSQL service
(for example the <code>rw</code> service), creating a separate, scalable, configurable,
and highly available <strong>database access layer</strong>.</p>
<h2 id="architecture">Architecture</h2>
<p>The following diagram highlights how the introduction of a database access
layer based on PgBouncer changes the architecture of Cloud Native PostgreSQL,
like an additional blade in a Swiss Army knife. Instead of directly connecting
to the PostgreSQL primary service, applications can now connect to the
equivalent service for PgBouncer, enabling reuse of existing connections for
faster performance and better resource management on the PostgreSQL side.</p>
<p><img src="./images/pgbouncer-architecture-rw.png" alt="Applications writing to the single primary via PgBouncer"></p>
<h2 id="quickstart">Quickstart</h2>
<p>The easiest way to explain how Cloud Native PostgreSQL implements a PgBouncer
pooler is through an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.k8s.enterprisedb.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pgbouncer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">poolMode</span>: <span style="color:#ae81ff">session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_client_conn</span>: <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default_pool_size</span>: <span style="color:#e6db74">&#34;10&#34;</span>
</span></span></code></pre></div><p>!!! Important
Pooler name should never match with any Cluster name within the same namespace.</p>
<p>This creates a new <code>Pooler</code> resource called <code>pooler-example-rw</code> (the name is
arbitrary) that is strictly associated with the Postgres <code>Cluster</code> resource called
<code>cluster-example</code> and pointing to the primary, identified by the read/write
service (<code>rw</code>, therefore <code>cluster-example-rw</code>).</p>
<p>The <code>Pooler</code> must live in the same namespace of the Postgres cluster.
It consists of a Kubernetes deployment of 3 pods running the
<a href="https://quay.io/repository/enterprisedb/pgbouncer">latest stable image of PgBouncer</a>,
configured with the <a href="https://www.pgbouncer.org/config.html#pool-mode"><code>session</code> pooling mode</a>
and accepting up to 1000 connections each - with a default pool size of 10
user/database pairs towards PostgreSQL.</p>
<p>!!! Important
The <code>Pooler</code> only sets the <code>*</code> fallback database in PgBouncer, meaning
that all parameters in the connection strings passed from the client are
relayed to the PostgreSQL server (please refer to <a href="https://www.pgbouncer.org/config.html#section-databases">&ldquo;Section [databases]&rdquo;
in PgBouncer&rsquo;s documentation</a>).</p>
<p>Additionally, Cloud Native PostgreSQL automatically creates a secret with the
same name of the pooler containing the configuration files used with PgBouncer.</p>
<p>!!! Seealso &ldquo;API reference&rdquo;
For details, please refer to <a href="api_reference.md#PgBouncerSpec"><code>PgBouncerSpec</code> section</a>
in the API reference.</p>
<h2 id="pooler-resource-lifecycle">Pooler resource lifecycle</h2>
<p><code>Pooler</code> resources are not <code>Cluster</code>-managed resources. You are supposed to
create poolers manually when they are needed. Additionally, you can deploy
multiple poolers per PostgreSQL Cluster.</p>
<p>What is important to note is that the lifecycles of the <code>Cluster</code> and the
<code>Pooler</code> resources are currently independent: the deletion of the <code>Cluster</code>
doesn&rsquo;t imply the automatic deletion of the <code>Pooler</code>, and viceversa.</p>
<p>!!! Important
Now that you know how a <code>Pooler</code> works, you have full freedom in terms of
possible architectures: you can have clusters without poolers, clusters with
a single pooler, or clusters with several poolers (i.e. one per application).</p>
<h2 id="security">Security</h2>
<p>Any PgBouncer pooler is transparently integrated with Cloud Native PostgreSQL
support for in-transit encryption via <strong>TLS connections</strong>, both on the client
(application) and server (PostgreSQL) side of the pool.</p>
<p>Specifically, PgBouncer automatically reuses the certificates of the PostgreSQL
server. Moreover, it uses TLS client certificate authentication to connect
to the PostgreSQL server to run the <code>auth_query</code> for clients&rsquo; password
authentication (see the <a href="#authentication">&ldquo;Authentication&rdquo; section</a> below).</p>
<p>Containers run as the <code>pgbouncer</code> system user, and access to the <code>pgbouncer</code>
database is only allowed via local connections, through <code>peer</code> authentication.</p>
<h2 id="authentication">Authentication</h2>
<p><strong>Password based authentication</strong> is the only supported method for clients of
PgBouncer in Cloud Native PostgreSQL.</p>
<p>Internally, our implementation relies on PgBouncer&rsquo;s <code>auth_user</code> and <code>auth_query</code> options. Specifically, the operator:</p>
<ul>
<li>creates a standard user called <code>cnp_pooler_pgbouncer</code> in the PostgreSQL server</li>
<li>creates the lookup function in the <code>postgres</code> database and grants execution
privileges to the <code>cnp_pooler_pgbouncer</code> user (PoLA)</li>
<li>issues a TLS certificate for this user</li>
<li>sets <code>cnp_pooler_pgbouncer</code> as the <code>auth_user</code></li>
<li>configures PgBouncer to use the TLS certificate to authenticate
<code>cnp_pooler_pgbouncer</code> against the PostgreSQL server</li>
<li>removes all the above when it detects that a cluster does not have
any pooler associated to it</li>
</ul>
<h2 id="podtemplates">PodTemplates</h2>
<p>You can take advantage of pod templates specification in the <code>template</code>
section of a <code>Pooler</code> resource. For details, please refer to <a href="api_reference.md#PoolerSpec"><code>PoolerSpec</code>
section</a> in the API reference.</p>
<p>Through templates you can configure pods as you like, including fine
control over affinity and anti-affinity rules for pods and nodes.
By default, containers use images from <code>quay.io/enterprisedb/pgbouncer</code>.</p>
<p>Here an example of Pooler specifying PodAntiAffinity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.k8s.enterprisedb.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>: []
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">topologyKey</span>: <span style="color:#e6db74">&#34;kubernetes.io/hostname&#34;</span>
</span></span></code></pre></div><p>!!! Note
<code>.spec.template.spec.containers</code> has to be explicitly set to <code>[]</code> when not modified, as it&rsquo;s a required field for a <code>PodSpec</code>.
If <code>.spec.template.spec.containers</code> is not set the kubernetes api-server will return the following error when trying to apply the manifest:
<code>error validating &quot;pooler.yaml&quot;: error validating data: ValidationError(Pooler.spec.template.spec): missing required field &quot;containers&quot;</code></p>
<p>Here an example setting resources and changing the used image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.k8s.enterprisedb.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pgbouncer</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">my-pgbouncer:latest</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span></code></pre></div><h2 id="high-availability-ha">High Availability (HA)</h2>
<p>Thanks to Kubernetes&rsquo; deployments, you can configure your pooler to run
on a single instance or over multiple pods. The exposed service will
make sure that your clients are randomly distributed over the available
pods running PgBouncer - which will then automatically manage and reuse
connections towards the underlying server (if using the <code>rw</code> service)
or servers (if using the <code>ro</code> service with multiple replicas).</p>
<p>!!! Warning
Please be aware of network hops in case your infrastructure spans
multiple availability zones with high latency across them. Consider
for example the case of your application running in zone 2,
connecting to PgBouncer running in zone 3, pointing to the PostgreSQL
primary in zone 1.</p>
<h2 id="pgbouncer-configuration-options">PgBouncer configuration options</h2>
<p>The operator manages most of the <a href="https://www.pgbouncer.org/config.html">configuration options for PgBouncer</a>, allowing you to modify only a subset of them.</p>
<p>!!! Warning
You are responsible to correctly set the value of each option, as the operator
does not validate them.</p>
<p>Below you can find a list of the PgBouncer options you are allowed to
customize. Each of them contains a link to the PgBouncer documentation for that
specific parameter. Unless differently stated here, the default values are the
ones directly set by PgBouncer:</p>
<ul>
<li><a href="https://www.pgbouncer.org/config.html#application_name_add_host"><code>application_name_add_host</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#autodb_idle_timeout"><code>autodb_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_idle_timeout"><code>client_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_login_timeout"><code>client_login_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#default_pool_size"><code>default_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#disable_pqexec"><code>disable_pqexec</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#idle_transaction_timeout"><code>idle_transaction_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#ignore_startup_parameters"><code>ignore_startup_parameters</code></a>:
to be appended to <code>extra_float_digits,options</code> - required by CNP</li>
<li><a href="https://www.pgbouncer.org/config.html#log_connections"><code>log_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_disconnections"><code>log_disconnections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_pooler_errors"><code>log_pooler_errors</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_stats"><code>log_stats</code></a>: by default
disabled (<code>0</code>), given that statistics are already collected by the Prometheus
export as described in the <a href="#monitoring">&ldquo;Monitoring&rdquo;</a> section below</li>
<li><a href="https://www.pgbouncer.org/config.html#max_client_conn"><code>max_client_conn</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_db_connections"><code>max_db_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_user_connections"><code>max_user_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#min_pool_size"><code>min_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_timeout"><code>query_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_wait_timeout"><code>query_wait_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_size"><code>reserve_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_timeout"><code>reserve_pool_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_delay"><code>server_check_delay</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_query"><code>server_check_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_connect_timeout"><code>server_connect_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_fast_close"><code>server_fast_close</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_idle_timeout"><code>server_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_lifetime"><code>server_lifetime</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_login_retry"><code>server_login_retry</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query"><code>server_reset_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query_always"><code>server_reset_query_always</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_round_robin"><code>server_round_robin</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#stats_period"><code>stats_period</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#verbose"><code>verbose</code></a></li>
</ul>
<p>Customizations of the PgBouncer configuration are written
declaratively in the <code>.spec.pgbouncer.parameters</code> map.</p>
<p>The operator reacts to the changes in the Pooler specification,
and every PgBouncer instance reloads the updated configuration
without disrupting the service.</p>
<p>!!! Warning
Every PgBouncer pod will have the same configuration, aligned
with the parameters in the specification. A mistake in these
parameters could disrupt the operability of the <strong>whole Pooler</strong>.
The operator <strong>does not</strong> validate the value of any option.</p>
<h2 id="monitoring">Monitoring</h2>
<p>The PgBouncer implementation of the <code>Pooler</code> comes with a default
Prometheus exporter that automatically makes available several
metrics having the <code>cnp_pgbouncer_</code> prefix, by running:</p>
<ul>
<li><code>SHOW LISTS</code> (prefix: <code>cnp_pgbouncer_lists</code>)</li>
<li><code>SHOW POOLS</code> (prefix: <code>cnp_pgbouncer_pools</code>)</li>
<li><code>SHOW STATS</code> (prefix: <code>cnp_pgbouncer_stats</code>)</li>
</ul>
<p>Similarly to the Cloud Native PostgreSQL instance, the exporter runs on port
<code>9127</code> of each pod running PgBouncer, and also provides metrics related to the
Go runtime (with prefix <code>go_*</code>). You can debug the exporter on a pod running
PgBouncer through the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>kubectl exec -ti &lt;PGBOUNCER_POD&gt; -- curl 127.0.0.1:9127/metrics
</span></span></code></pre></div><p>An example of the output for <code>cnp_pgbouncer</code> metrics:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># HELP cnp_pgbouncer_collection_duration_seconds Collection time duration in seconds
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_collection_duration_seconds gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_collection_duration_seconds{collector=&#34;Collect.up&#34;} 0.002443168
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_collections_total Total number of times PostgreSQL was accessed for metrics.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_collections_total counter
</span></span><span style="display:flex;"><span>cnp_pgbouncer_collections_total 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_last_collection_error 1 if the last collection ended with error, 0 otherwise.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_last_collection_error gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_last_collection_error 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_databases Count of databases.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_databases gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_databases 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_dns_names Count of DNS names in the cache.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_dns_names gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_dns_names 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_dns_pending Not used.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_dns_pending gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_dns_pending 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_dns_queries Count of in-flight DNS queries.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_dns_queries gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_dns_queries 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_dns_zones Count of DNS zones in the cache.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_dns_zones gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_dns_zones 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_free_clients Count of free clients.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_free_clients gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_free_clients 49
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_free_servers Count of free servers.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_free_servers gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_free_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_login_clients Count of clients in login state.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_login_clients gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_login_clients 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_pools Count of pools.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_pools gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_pools 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_used_clients Count of used clients.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_used_clients gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_used_clients 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_used_servers Count of used servers.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_used_servers gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_used_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_lists_users Count of users.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_lists_users gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_lists_users 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_cl_active Client connections that are linked to server connection and can process queries.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_cl_active gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_cl_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_cl_cancel_req Client connections that have not forwarded query cancellations to the server yet.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_cl_cancel_req gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_cl_cancel_req{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_cl_waiting Client connections that have sent queries but have not yet got a server connection.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_cl_waiting gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_cl_waiting{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_maxwait How long the first (oldest) client in the queue has waited, in seconds. If this starts increasing, then the current pool of servers does not handle requests quickly enough. The reason may be either an overloaded server or just too small of a pool_size setting.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_maxwait gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_maxwait{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_maxwait_us Microsecond part of the maximum waiting time.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_maxwait_us gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_maxwait_us{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_pool_mode The pooling mode in use. 1 for session, 2 for transaction, 3 for statement, -1 if unknown
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_pool_mode gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_pool_mode{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_sv_active Server connections that are linked to a client.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_sv_active gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_sv_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_sv_idle Server connections that are unused and immediately usable for client queries.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_sv_idle gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_sv_idle{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_sv_login Server connections currently in the process of logging in.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_sv_login gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_sv_login{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_sv_tested Server connections that are currently running either server_reset_query or server_check_query.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_sv_tested gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_sv_tested{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_pools_sv_used Server connections that have been idle for more than server_check_delay, so they need server_check_query to run on them before they can be used again.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_pools_sv_used gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_pools_sv_used{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_query_count Average queries per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_query_count gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_query_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_query_time Average query duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_query_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_recv Average received (from clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_recv gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_recv{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_sent Average sent (to clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_sent gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_wait_time Time spent by clients waiting for a server, in microseconds (average per second).
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_wait_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_xact_count Average transactions per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_xact_count gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_xact_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_avg_xact_time Average transaction duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_avg_xact_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_avg_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_query_count Total number of SQL queries pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_query_count gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_query_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_query_time Total number of microseconds spent by pgbouncer when actively connected to PostgreSQL, executing queries.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_query_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_received Total volume in bytes of network traffic received by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_received gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_received{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_sent Total volume in bytes of network traffic sent by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_sent gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_wait_time Time spent by clients waiting for a server, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_wait_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_xact_count Total number of SQL transactions pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_xact_count gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_xact_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnp_pgbouncer_stats_total_xact_time Total number of microseconds spent by pgbouncer when connected to PostgreSQL in a transaction, either idle in transaction or executing queries.
</span></span><span style="display:flex;"><span># TYPE cnp_pgbouncer_stats_total_xact_time gauge
</span></span><span style="display:flex;"><span>cnp_pgbouncer_stats_total_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span></code></pre></div><p>Like for <code>Clusters</code>, if you are using the <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a>
you can configure it to scrape a specific Pooler by defining the following <a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodMonitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">k8s.enterprisedb.io/poolerName</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">metrics</span>
</span></span></code></pre></div><h2 id="logging">Logging</h2>
<p>Logs are directly sent to standard output, in JSON format, like in the
following example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;info&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ts&#34;</span>: <span style="color:#960050;background-color:#1e0010">SECONDS.MICROSECONDS</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;record&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;pipe&#34;</span>: <span style="color:#e6db74">&#34;stderr&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;record&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;timestamp&#34;</span>: <span style="color:#e6db74">&#34;YYYY-MM-DD HH:MM:SS.MS UTC&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;pid&#34;</span>: <span style="color:#e6db74">&#34;&lt;PID&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;LOG&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;kernel file descriptor limit: 1048576 (hard: 1048576); max_client_conn: 100, max expected fd use: 112&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="pausing-connections">Pausing connections</h2>
<p>The <code>Pooler</code> specification allows you to take advantage of PgBouncer&rsquo;s <code>PAUSE</code>
and <code>RESUME</code> commands, using only declarative configuration - via the <code>paused</code>
option, by default set to <code>false</code>. When set to <code>true</code>, the operator internally
invokes the <code>PAUSE</code> command in PgBouncer, which:</p>
<ol>
<li>closes all active connections towards the PostgreSQL server, after waiting for the queries to complete</li>
<li>pauses any new connection coming from the client</li>
</ol>
<p>When the <code>paused</code> option is set back to <code>false</code>, the operator will invoke the
<code>RESUME</code> command in PgBouncer, re-opening the taps towards the PostgreSQL
service defined in the <code>Pooler</code>.</p>
<p>!!! Seealso &ldquo;PAUSE&rdquo;
For further information, please refer to the
<a href="https://www.pgbouncer.org/usage.html#pause-db"><code>PAUSE</code> section in the PgBouncer documentation</a>.</p>
<p>!!! Important
In future versions, the switchover operation will be fully integrated
with the PgBouncer pooler, and take advantage of the <code>PAUSE</code>/<code>RESUME</code>
features to reduce the perceived downtime by client applications.
At the moment, you can achieve the same results by setting the <code>paused</code>
attribute to <code>true</code>, then issuing the switchover command through the
<a href="cnp-plugin.md#promote"><code>cnp</code> plugin</a>, and finally restoring the <code>paused</code>
attribute to <code>false</code>.</p>
<h2 id="limitations">Limitations</h2>
<h3 id="single-postgresql-cluster">Single PostgreSQL cluster</h3>
<p>The current implementation of the pooler is designed to work as part of a
specific Cloud Native PostgreSQL cluster (a service, to be precise). It is not
possible at the moment to create a pooler that spans over multiple clusters.</p>
<h3 id="controlled-configurability">Controlled configurability</h3>
<p>Cloud Native PostgreSQL transparently manages several configuration options
that are used for the PgBouncer layer to communicate with PostgreSQL. Such
options are not configurable from outside and include TLS certificates,
authentication settings, <code>databases</code> section, and <code>users</code> section. Also,
considering the specific use case for the single PostgreSQL cluster, the
adopted criteria is to explicitly list the options that can be configured by
users.</p>
<p>!!! Note
We have reasons to believe that the adopted solution addresses the majority of
use cases, while leaving room for the future implementation of a separate
operator for PgBouncer to complete the gamma with more advanced and customized
scenarios.</p>



    <footer class="text-center p-24">
    <div>
        <a href="#" class="bg-rose-600 py-4 px-12 rounded-full text-white text-xl">View on GitHub</a>
    </div>
    <p class="text-sm text-slate-600 w-1/2 mx-auto pt-10">&copy; 2019-2022 The CloudNativePG Contributors<br/>
    The Linux Foundation has registered trademarks and uses trademarks. 
    For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/" class="text-rose-600">Trademark Usage page</a>.<br/>
    Postgres, PostgreSQL and the Slonik Logo are trademarks or registered trademarks of the PostgreSQL Community Association of Canada, and used with their permission.
    </p>
</footer>

  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>
<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
  <link rel="favicon" href="/favicon/favicon.ico">
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="flex flex-row px-16 justify-between py-5">
      <div>
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      <div>
        <ul class="flex gap-14 text-2xl text-slate-400 my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Support</li>
          <li>End users</li>
          <li>Blog</li>
        </ul>
      </div>
      <div class="flex gap-5 my-4">
        <a href="https://github.com/cloudnative-pg/cloudnative-pg">
          <img src="/icons/Git.svg" alt="Github">
        </a>
        <a href="https://cloudnativepg.slack.com/">
          <img src="/icons/Slack.svg" alt="Slack">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>


    
<h2 class="text-2xl"></h2>
<h1 id="exposing-postgres-services">Exposing Postgres Services</h1>
<p>This section explains how to expose a PostgreSQL service externally, allowing access
to your PostgreSQL database <strong>from outside your Kubernetes cluster</strong> using
NGINX Ingress Controller.</p>
<p>If you followed the <a href="./quickstart.md">QuickStart</a>, you should have by now
a database that can be accessed inside the cluster via the
<code>cluster-example-rw</code> (primary) and <code>cluster-example-r</code> (read-only)
services in the <code>default</code> namespace. Both services use port <code>5432</code>.</p>
<p>Let&rsquo;s assume that you want to make the primary instance accessible from external
accesses on port <code>5432</code>. A typical use case, when moving to a Kubernetes
infrastructure, is indeed the one represented by <strong>legacy applications</strong>
that cannot be easily or sustainably &ldquo;containerized&rdquo;. A sensible workaround
is to allow those applications that most likely reside in a virtual machine
or a physical server, to access a PostgreSQL database inside a Kubernetes cluster
in the same network.</p>
<p>!!! Warning
Allowing access to a database from the public network could expose
your database to potential attacks from malicious users. Ensure you
secure your database before granting external access or that your
Kubernetes cluster is only reachable from a private network.</p>
<p>For this example, you will use <a href="https://kubernetes.github.io/ingress-nginx/">NGINX Ingress Controller</a>,
since it is maintained directly by the Kubernetes project and can be set up
on every Kubernetes cluster. Many other controllers are available (see the
<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Kubernetes documentation</a>
for a comprehensive list).</p>
<p>We assume that:</p>
<ul>
<li>the NGINX Ingress controller has been deployed and works correctly</li>
<li>it is possible to create a service of type <code>LoadBalancer</code> in your cluster</li>
</ul>
<p>!!! Important
Ingresses are only required to expose HTTP and HTTPS traffic. While the NGINX
Ingress controller can, not all Ingress objects can expose arbitrary ports or
protocols.</p>
<p>The first step is to create a <code>tcp-services</code> <code>ConfigMap</code> whose data field
contains info on the externally exposed port and the namespace, service and
port to point to internally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tcp-services</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">5432</span>: <span style="color:#ae81ff">default/cluster-example-rw:5432</span>
</span></span></code></pre></div><p>Then, if you&rsquo;ve installed NGINX Ingress Controller as suggested in their
documentation, you should have an <code>ingress-nginx</code> service. You&rsquo;ll have to add
the 5432 port to the <code>ingress-nginx</code> service to expose it.
The ingress will redirect incoming connections on port 5432 to your database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">postgres</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/part-of</span>: <span style="color:#ae81ff">ingress-nginx</span>
</span></span></code></pre></div><p>You can use <a href="samples/cluster-expose-service.yaml"><code>cluster-expose-service.yaml</code></a>  and apply it
using <code>kubectl</code>.</p>
<p>!!! Warning
If you apply this file directly, you will overwrite any previous change
in your <code>ConfigMap</code> and <code>Service</code> of the Ingress</p>
<p>Now you will be able to reach the PostgreSQL Cluster from outside your Kubernetes cluster.</p>
<p>!!! Important
Make sure you configure <code>pg_hba</code> to allow connections from the Ingress.</p>
<h2 id="testing-on-minikube">Testing on Minikube</h2>
<p>On Minikube you can setup the ingress controller running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>minikube addons enable ingress
</span></span></code></pre></div><p>Then, patch the <code>tcp-service</code> ConfigMap to redirect to the primary the
connections on port 5432 of the Ingress:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl patch configmap tcp-services -n kube-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --patch <span style="color:#e6db74">&#39;{&#34;data&#34;:{&#34;5432&#34;:&#34;default/cluster-example-rw:5432&#34;}}&#39;</span>
</span></span></code></pre></div><p>You can then patch the deployment to allow access on port 5432.
Create a file called <code>patch.yaml</code> with the following content:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-ingress-controller</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>         - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">5432</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">hostPort</span>: <span style="color:#ae81ff">5432</span>
</span></span></code></pre></div><p>and apply it to the <code>nginx-ingress-controller deployment</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl patch deployment nginx-ingress-controller --patch <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat patch.yaml<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -n kube-system
</span></span></code></pre></div><p>You can access the primary from your machine running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>psql -h <span style="color:#66d9ef">$(</span>minikube ip<span style="color:#66d9ef">)</span> -p <span style="color:#ae81ff">5432</span> -U postgres
</span></span></code></pre></div>


    <footer class="text-center p-24">
    <div>
        <a href="#" class="bg-rose-600 py-4 px-12 rounded-full text-white text-xl">View on GitHub</a>
    </div>
    <p class="text-sm text-slate-600 w-1/2 mx-auto pt-10">&copy; 2019-2022 The CloudNativePG Contributors<br/>
    The Linux Foundation has registered trademarks and uses trademarks. 
    For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/" class="text-rose-600">Trademark Usage page</a>.<br/>
    Postgres, PostgreSQL and the Slonik Logo are trademarks or registered trademarks of the PostgreSQL Community Association of Canada, and used with their permission.
    </p>
</footer>

  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>
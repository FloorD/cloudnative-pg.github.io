<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="flex flex-row px-16 justify-between py-5">
      <div>
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      <div>
        <ul class="flex gap-14 text-2xl text-slate-400 my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Support</li>
          <li>End users</li>
          <li>Blog</li>
        </ul>
      </div>
      <div class="flex gap-5 my-4">
        <a href="https://github.com/cloudnative-pg/cloudnative-pg">
          <img src="/icons/Git.svg" alt="Github">
        </a>
        <a href="https://cloudnativepg.slack.com/">
          <img src="/icons/Slack.svg" alt="Slack">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>


    
<h2 class="text-2xl"></h2>
<h1 id="troubleshooting">Troubleshooting</h1>
<p>In this page, you can find some basic information on how to troubleshoot Cloud
Native PostgreSQL in your Kubernetes cluster deployment.</p>
<p>!!! Hint
As a Kubernetes administrator, you should have the
<a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/"><code>kubectl</code> Cheat Sheet</a> page
bookmarked!</p>
<h2 id="before-you-start">Before you start</h2>
<h3 id="kubernetes-environment">Kubernetes environment</h3>
<p>What can make a difference in a troubleshooting activity is to provide
clear information about the underlying Kubernetes system.</p>
<p>Make sure you know:</p>
<ul>
<li>the Kubernetes distribution and version you are using</li>
<li>the specifications of the nodes where PostgreSQL is running</li>
<li>as much as you can about the actual <a href="storage.md">storage</a>, including storage
class and benchmarks you have done before going into production.</li>
<li>which relevant Kubernetes applications you are using in your cluster (i.e.
Prometheus, Grafana, Istio, Certmanager, &hellip;)</li>
</ul>
<h3 id="useful-utilities">Useful utilities</h3>
<p>On top of the mandatory <code>kubectl</code> utility, for troubleshooting, we recommend the
following plugins/utilities to be available in your system:</p>
<ul>
<li><a href="cnp-plugin.md"><code>cnp</code> plugin</a> for <code>kubectl</code></li>
<li><a href="https://stedolan.github.io/jq/"><code>jq</code></a>, a lightweight and flexible command-line JSON processor</li>
<li><a href="https://www.gnu.org/software/grep/"><code>grep</code></a>, searches one or more input files
for lines containing a match to a specified pattern. It is already available in most *nix distros.
If you are on Windows OS, you can use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr"><code>findstr</code></a> as an alternative to <code>grep</code> or directly use <a href="https://docs.microsoft.com/en-us/windows/wsl/"><code>wsl</code></a>
and install your preferred *nix distro and use the tools mentioned above.</li>
</ul>
<h3 id="logs">Logs</h3>
<p>Every resource created and controlled by Cloud Native PostgreSQL logs to
standard output, as expected by Kubernetes, and directly in <a href="logging.md">JSON
format</a>. As a result, you should rely on the <code>kubectl logs</code>
command to retrieve logs from a given resource.</p>
<p>For more information, type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs --help
</span></span></code></pre></div><p>!!! Hint
JSON logs are great for machine reading, but hard to read for human beings.
Our recommendation is to use the <code>jq</code> command to improve usability. For
example, you can <em>pipe</em> the <code>kubectl logs</code> command with <code>| jq -C</code>.</p>
<p>!!! Note
In the sections below, we will show some examples on how to retrieve logs
about different resources when it comes to troubleshooting Cloud Native
PostgreSQL.</p>
<h2 id="operator-information">Operator information</h2>
<p>By default, the Cloud Native PostgreSQL operator is installed in the
<code>postgresql-operator-system</code> namespace in Kubernetes as a <code>Deployment</code>
(see the <a href="installation_upgrade.md#details-about-the-deployment">&ldquo;Details about the deployment&rdquo; section</a>
for details).</p>
<p>You can get a list of the operator pods by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get pods -n postgresql-operator-system
</span></span></code></pre></div><p>!!! Note
Under normal circumstances, you should have one pod where the operator is
running, identified by a name starting with <code>postgresql-operator-controller-manager-</code>.
In case you have set up your operator for high availability, you should have more entries.
Those pods are managed by a deployment named <code>postgresql-operator-controller-manager</code>.</p>
<p>Collect the relevant information about the operator that is running in pod
<code>&lt;POD&gt;</code> with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl describe pod -n postgresql-operator-system &lt;POD&gt;
</span></span></code></pre></div><p>Then get the logs from the same pod by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get logs -n postgresql-operator-system &lt;POD&gt;
</span></span></code></pre></div><h3 id="gather-more-information-about-the-operator">Gather more information about the operator</h3>
<p>Get logs from all pods in Cloud Native PostgreSQL operator Deployment
(in case you have a multi operator deployment) by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n postgresql-operator-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  deployment/postgresql-operator-controller-manager --all-containers<span style="color:#f92672">=</span>true
</span></span></code></pre></div><p>!!! Tip
You can add <code>-f</code> flag to above command to follow logs in real time.</p>
<p>Save logs to a JSON file by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n postgresql-operator-system <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  deployment/postgresql-operator-controller-manager --all-containers<span style="color:#f92672">=</span>true | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r . &gt; cnp_logs.json
</span></span></code></pre></div><p>Get Cloud Native PostgreSQL operator version by using <code>kubectl-cnp</code> plugin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl-cnp status &lt;CLUSTER&gt;
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Cluster in healthy state
</span></span><span style="display:flex;"><span>Name:               cluster-example
</span></span><span style="display:flex;"><span>Namespace:          default
</span></span><span style="display:flex;"><span>System ID:          <span style="color:#ae81ff">7044925089871458324</span>
</span></span><span style="display:flex;"><span>PostgreSQL Image:   quay.io/enterprisedb/postgresql:14.1-3
</span></span><span style="display:flex;"><span>Primary instance:   cluster-example-1
</span></span><span style="display:flex;"><span>Instances:          <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>Ready instances:    <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>Current Write LSN:  0/5000000 <span style="color:#f92672">(</span>Timeline: <span style="color:#ae81ff">1</span> - WAL File: 000000010000000000000004<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Continuous Backup status
</span></span><span style="display:flex;"><span>Not configured
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Streaming Replication status
</span></span><span style="display:flex;"><span>Name               Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag       Flush Lag       Replay Lag      State      Sync State  Sync Priority
</span></span><span style="display:flex;"><span>----               --------   ---------  ---------  ----------  ---------       ---------       ----------      -----      ----------  -------------
</span></span><span style="display:flex;"><span>cluster-example-2  0/5000000  0/5000000  0/5000000  0/5000000   00:00:00        00:00:00        00:00:00        streaming  async       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>cluster-example-3  0/5000000  0/5000000  0/5000000  0/5000000   00:00:00.10033  00:00:00.10033  00:00:00.10033  streaming  async       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Instances status
</span></span><span style="display:flex;"><span>Name               Database Size  Current LSN  Replication role  Status  QoS         Manager Version
</span></span><span style="display:flex;"><span>----               -------------  -----------  ----------------  ------  ---         ---------------
</span></span><span style="display:flex;"><span>cluster-example-1  <span style="color:#ae81ff">33</span> MB          0/5000000    Primary           OK      BestEffort  1.12.0
</span></span><span style="display:flex;"><span>cluster-example-2  <span style="color:#ae81ff">33</span> MB          0/5000000    Standby <span style="color:#f92672">(</span>async<span style="color:#f92672">)</span>   OK      BestEffort  1.12.0
</span></span><span style="display:flex;"><span>cluster-example-3  <span style="color:#ae81ff">33</span> MB          0/5000060    Standby <span style="color:#f92672">(</span>async<span style="color:#f92672">)</span>   OK      BestEffort  1.12.0
</span></span></code></pre></div><h2 id="cluster-information">Cluster information</h2>
<p>You can check the status of the <code>&lt;CLUSTER&gt;</code> cluster in the <code>NAMESPACE</code>
namespace with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get cluster -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>NAME        AGE        INSTANCES   READY   STATUS                     PRIMARY
</span></span><span style="display:flex;"><span>&lt;CLUSTER&gt;   10d4h3m    <span style="color:#ae81ff">3</span>           <span style="color:#ae81ff">3</span>       Cluster in healthy state   &lt;CLUSTER&gt;-1
</span></span></code></pre></div><p>The above example reports a healthy PostgreSQL cluster of 3 instances, all in
<em>ready</em> state, and with <code>&lt;CLUSTER&gt;-1</code> being the primary.</p>
<p>In case of unhealthy conditions, you can discover more by getting the manifest
of the <code>Cluster</code> resource:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get cluster -o yaml -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;
</span></span></code></pre></div><p>Another important command to gather is the <code>status</code> one, as provided by the
<code>cnp</code> plugin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl cnp status -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;
</span></span></code></pre></div><p>!!! Tip
You can print more information by adding the <code>--verbose</code> option.</p>
<p>!!! Note
Besides knowing cluster status, you can also do the following things with the cnp plugin:
Promote a replica.<!-- raw HTML omitted -->
Manage certificates.<!-- raw HTML omitted -->
Make a rollout restart cluster to apply configuration changes.<!-- raw HTML omitted -->
Make a reconciliation loop to reload and apply configuration changes.<!-- raw HTML omitted -->
For more information, please see <a href="cnp-plugin.md"><code>cnp</code> plugin</a> documentation.</p>
<p>Get PostgreSQL container image version:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl describe cluster &lt;CLUSTER_NAME&gt; -n &lt;NAMESPACE&gt; | grep <span style="color:#e6db74">&#34;Image Name&#34;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  Image Name:    quay.io/enterprisedb/postgresql:14.1-3
</span></span></code></pre></div><p>!!! Note
Also you can use <code>kubectl-cnp status -n &lt;NAMESPACE&gt; &lt;CLUSTER_NAME&gt;</code>
to get the same information.</p>
<h2 id="pod-information">Pod information</h2>
<p>You can retrieve the list of instances that belong to a given PostgreSQL
cluster with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># using labels available from CNP 1.12.0</span>
</span></span><span style="display:flex;"><span>kubectl get pod -l k8s.enterprisedb.io/cluster<span style="color:#f92672">=</span>&lt;CLUSTER&gt; -L role -n &lt;NAMESPACE&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># using legacy labels</span>
</span></span><span style="display:flex;"><span>kubectl get pod -l postgresql<span style="color:#f92672">=</span>&lt;CLUSTER&gt; -L role -n &lt;NAMESPACE&gt;
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE       ROLE
</span></span><span style="display:flex;"><span>&lt;CLUSTER&gt;-1   1/1     Running   <span style="color:#ae81ff">0</span>          10d4h5m   primary
</span></span><span style="display:flex;"><span>&lt;CLUSTER&gt;-2   1/1     Running   <span style="color:#ae81ff">0</span>          10d4h4m   replica
</span></span><span style="display:flex;"><span>&lt;CLUSTER&gt;-3   1/1     Running   <span style="color:#ae81ff">0</span>          10d4h4m   replica
</span></span></code></pre></div><p>You can check if/how a pod is failing by running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get pod -n &lt;NAMESPACE&gt; -o yaml &lt;CLUSTER&gt;-&lt;N&gt;
</span></span></code></pre></div><p>You can get all the logs for a given PostgreSQL instance with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt;
</span></span></code></pre></div><p>If you want to limit the search to the PostgreSQL process only, you can run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq <span style="color:#e6db74">&#39;select(.logger==&#34;postgres&#34;) | .record.message&#39;</span>
</span></span></code></pre></div><p>The following example also adds the timestamp in a user-friendly format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r <span style="color:#e6db74">&#39;select(.logger==&#34;postgres&#34;) | [(.ts|strflocaltime(&#34;%Y-%m-%dT%H:%M:%S %Z&#34;)), .record.message] | @csv&#39;</span>
</span></span></code></pre></div><h3 id="gather-and-filter-extra-information-about-postgresql-pods">Gather and filter extra information about PostgreSQL pods</h3>
<p>Check logs from a specific pod that has crashed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; --previous &lt;CLUSTER&gt;-&lt;N&gt;
</span></span></code></pre></div><p>Get FATAL errors from a specific PostgreSQL pod:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r <span style="color:#e6db74">&#39;.record | select(.error_severity == &#34;FATAL&#34;)&#39;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;log_time&#34;</span>: <span style="color:#e6db74">&#34;2021-11-08 14:07:44.520 UTC&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;user_name&#34;</span>: <span style="color:#e6db74">&#34;streaming_replica&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;process_id&#34;</span>: <span style="color:#e6db74">&#34;68&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;connection_from&#34;</span>: <span style="color:#e6db74">&#34;10.244.0.10:60616&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;session_id&#34;</span>: <span style="color:#e6db74">&#34;61892f30.44&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;session_line_num&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;command_tag&#34;</span>: <span style="color:#e6db74">&#34;startup&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;session_start_time&#34;</span>: <span style="color:#e6db74">&#34;2021-11-08 14:07:44 UTC&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;virtual_transaction_id&#34;</span>: <span style="color:#e6db74">&#34;3/75&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;transaction_id&#34;</span>: <span style="color:#e6db74">&#34;0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;error_severity&#34;</span>: <span style="color:#e6db74">&#34;FATAL&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;sql_state_code&#34;</span>: <span style="color:#e6db74">&#34;28000&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;role \&#34;streaming_replica\&#34; does not exist&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;backend_type&#34;</span>: <span style="color:#e6db74">&#34;walsender&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Filter PostgreSQL DB error messages in logs for a specific pod:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | jq -r <span style="color:#e6db74">&#39;.err | select(. != null)&#39;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>dial unix /controller/run/.s.PGSQL.5432: connect: no such file or directory
</span></span></code></pre></div><p>Get messages matching <code>err</code> word from a specific pod:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | jq -r <span style="color:#e6db74">&#39;.msg&#39;</span> | grep <span style="color:#e6db74">&#34;err&#34;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2021-11-08 14:07:39.610 UTC <span style="color:#f92672">[</span>15<span style="color:#f92672">]</span> LOG:  ending log output to stderr
</span></span></code></pre></div><p>Get all logs from PostgreSQL process from a specific pod:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r <span style="color:#e6db74">&#39;. | select(.logger == &#34;postgres&#34;) | select(.msg != &#34;record&#34;) | .msg&#39;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2021-11-08 14:07:52.591 UTC <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span> LOG:  redirecting log output to logging collector process
</span></span><span style="display:flex;"><span>2021-11-08 14:07:52.591 UTC <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span> HINT:  Future log output will appear in directory <span style="color:#e6db74">&#34;/controller/log&#34;</span>.
</span></span><span style="display:flex;"><span>2021-11-08 14:07:52.591 UTC <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span> LOG:  ending log output to stderr
</span></span><span style="display:flex;"><span>2021-11-08 14:07:52.591 UTC <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span> HINT:  Future log output will go to log destination <span style="color:#e6db74">&#34;csvlog&#34;</span>.
</span></span></code></pre></div><p>Get pod logs filtered by fields with values and join them separated by <code>|</code> running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl logs -n &lt;NAMESPACE&gt; &lt;CLUSTER&gt;-&lt;N&gt; | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r <span style="color:#e6db74">&#39;[.level, .ts, .logger, .msg] | join(&#34; | &#34;)&#39;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>info | 1636380469.5728037 | wal-archive | Backup not configured, skip WAL archiving
</span></span><span style="display:flex;"><span>info | 1636383566.0664876 | postgres | record
</span></span></code></pre></div><h2 id="backup-information">Backup information</h2>
<p>You can list the backups that have been created for a named cluster with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get backup -l k8s.enterprisedb.io/cluster<span style="color:#f92672">=</span>&lt;CLUSTER&gt;
</span></span></code></pre></div><p>!!! Important
Backup labelling has been introduced in version 1.10.0 of Cloud Native
PostgreSQL. So only those resources that have been created with that version or
a higher one will contain such a label.</p>
<h2 id="storage-information">Storage information</h2>
<p>Sometimes is useful to double-check the StorageClass used by the cluster to have
some more context during investigations or troubleshooting, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>STORAGECLASS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pvc &lt;POD&gt; -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.spec.storageClassName}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>kubectl get storageclasses $STORAGECLASS -o yaml
</span></span></code></pre></div><p>We are taking the StorageClass from one of the cluster pod here since often
clusters are created using the default StorageClass.</p>
<h2 id="node-information">Node information</h2>
<p>Kubernetes nodes is where ultimately PostgreSQL pods will be running. It&rsquo;s
strategically important to know as much as we can about them.</p>
<p>You can get the list of nodes in your Kubernetes cluster with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># look at the worker nodes and their status</span>
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide
</span></span></code></pre></div><p>Additionally, you can gather the list of nodes where the pods of a given
cluster are running with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get pod -l k8s.enterprisedb.io/clusterName<span style="color:#f92672">=</span>&lt;CLUSTER&gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -L role -n &lt;NAMESPACE&gt; -o wide
</span></span></code></pre></div><p>The latter is important to understand where your pods are distributed - very
useful if you are using <a href="scheduling.md">affinity/anti-affinity rules and/or tolerations</a>.</p>
<h2 id="conditions">Conditions</h2>
<p>Like many native kubernetes
objects <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions">like here</a>,
Cluster exposes <code>status.conditions</code> as well. This allows one to &lsquo;wait&rsquo; for a particular
event to occur instead of relying on the overall cluster health state. Available conditions as of now are:</p>
<ul>
<li>ContinuousArchiving</li>
</ul>
<h3 id="how-to-wait-for-a-particular-condition">How to wait for a particular condition</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl wait --for<span style="color:#f92672">=</span>condition<span style="color:#f92672">=</span>ContinuousArchiving cluster/&lt;cluster-name&gt;
</span></span></code></pre></div><p>Below is a snippet of a <code>cluster.status</code> that contains a failing condition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get cluster/&lt;cluster-name&gt; -o yaml
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>  status:
</span></span><span style="display:flex;"><span>    conditions:
</span></span><span style="display:flex;"><span>    - message: <span style="color:#e6db74">&#39;unexpected failure invoking barman-cloud-wal-archive: exit status
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        4&#39;</span>
</span></span><span style="display:flex;"><span>      reason: Continuous Archiving is Failing
</span></span><span style="display:flex;"><span>      status: <span style="color:#e6db74">&#34;False&#34;</span>
</span></span><span style="display:flex;"><span>      type: ContinuousArchiving
</span></span></code></pre></div><h2 id="some-common-issues">Some common issues</h2>
<h3 id="storage-is-full">Storage is full</h3>
<p>If one or more pods in the cluster are in <code>CrashloopBackoff</code> and logs
suggest this could be due to a full disk, you probably have to increase the
size of the instance&rsquo;s <code>PersistentVolumeClaim</code>. Please look at the
<a href="storage.md#volume-expansion">&ldquo;Volume expansion&rdquo; section</a> in the documentation.</p>
<h3 id="pods-are-stuck-in-pending-state">Pods are stuck in <code>Pending</code> state</h3>
<p>In case a Cluster&rsquo;s instance is stuck in the <code>Pending</code> phase, you should check
the pod&rsquo;s <code>Events</code> section to get an idea of the reasons behind this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl describe pod -n &lt;NAMESPACE&gt; &lt;POD&gt;
</span></span></code></pre></div><p>Some of the possible causes for this are:</p>
<ul>
<li>No nodes are matching the <code>nodeSelector</code></li>
<li>Tolerations are not correctly configured to match the nodes&rsquo; taints</li>
<li>No nodes are available at all: this could also be related to
<code>cluster-autoscaler</code> hitting some limits, or having some temporary issues</li>
</ul>
<p>In this case, it could also be useful to check events in the namespace:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubectl get events -n &lt;NAMESPACE&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># list events in chronological order</span>
</span></span><span style="display:flex;"><span>kubectl get events -n &lt;NAMESPACE&gt; --sort-by<span style="color:#f92672">=</span>.metadata.creationTimestamp
</span></span></code></pre></div><h3 id="replicas-out-of-sync-when-no-backup-is-configured">Replicas out of sync when no backup is configured</h3>
<p>Sometimes replicas might be switched off for a bit of time due to maintenance
reasons (think of when a Kubernetes nodes is drained). In case your cluster
does not have backup configured, when replicas come back up, they might
require a WAL file that is not present anymore on the primary (having been
already recycled according to the WAL management policies as mentioned in
<a href="postgresql_conf.md#the-postgresql-section">&ldquo;The <code>postgresql</code> section&rdquo;</a>), and
fall out of synchronization.</p>
<p>Similarly, when <code>pg_rewind</code> might require a WAL file that is not present
anymore in the former primary, reporting <code>pg_rewind: error: could not open file</code>.</p>
<p>In these cases, pods cannot become ready anymore, and you are required to delete
the PVC and let the operator rebuild the replica.</p>
<p>If you rely on dynamically provisioned Persistent Volumes, and you are confident
in deleting the PV itself, you can do so with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>PODNAME<span style="color:#f92672">=</span>&lt;POD&gt;
</span></span><span style="display:flex;"><span>VOLNAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl get pv -o json | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  jq -r <span style="color:#e6db74">&#39;.items[]|select(.spec.claimRef.name==&#39;</span><span style="color:#ae81ff">\&#34;</span>$PODNAME<span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#39;)|.metadata.name&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete pod/$PODNAME pvc/$PODNAME pv/$VOLNAME
</span></span></code></pre></div>


    <footer class="text-center p-24">
    <div>
        <a href="#" class="bg-rose-600 py-4 px-12 rounded-full text-white text-xl">View on GitHub</a>
    </div>
    <p class="text-sm text-slate-600 w-1/2 mx-auto pt-10">&copy; 2019-2022 The CloudNativePG Contributors<br/>
    The Linux Foundation has registered trademarks and uses trademarks. 
    For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/" class="text-rose-600">Trademark Usage page</a>.<br/>
    Postgres, PostgreSQL and the Slonik Logo are trademarks or registered trademarks of the PostgreSQL Community Association of Canada, and used with their permission.
    </p>
</footer>

  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>
<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link rel="preload" href="/css/Supreme-Variable.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
  <link rel="favicon" href="/favicon/favicon.ico">
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="md:flex md:flex-row md:px-16 md:justify-between py-5">
      <div class="flex justify-between px-4 md:hidden">
        <div>
          
          <a href="/"><img src="/logo/large_logo.svg" class="md:h-14 h-9" alt="Cloud Native Postgres Logo"></a>
        </div>
        <div class="h-6 my-auto" id="toggle-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </div>
      </div>
      <div class="md:block hidden">
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      
      <div class="hidden md:block">
        <ul class="md:flex gap-14 text-2xl medium-gray my-5">
          <li><a href="/docs/1.15.0">Documentation</a></li>
          <li><a href="/blog">Blog</a></li>
          <li><a href="/support">Support</a></li>
          <li><a href="/end_users">End Users</a></li>
        </ul>
      </div>
      
      <div class="py-4 bg-gray-1 mt-5 hidden" id="navi-list">
        <ul class="md:flex gap-14 text-2xl md:medium-gray charcoal">
          <li class="text-center py-4"><a href="/docs">Documentation</a></li>
          <li class="text-center py-4"><a href="/blog">Blog</a></li>
          <li class="text-center py-4"><a href="/support">Support</a></li>
          <li class="text-center py-4"><a href="/end_users">End Users</a></li>
        </ul>
        <div class="flex gap-3 py-4 justify-center bg-gray-1 fill-cnp-blue">
          <a href="https://github.com/cloudnative-pg/cloudnative-pg">
            <img src="/icons/Git.svg" alt="Github">
          </a>
          <a href="https://cloudnativepg.slack.com/">
            <img src="/icons/Slack.svg" alt="Slack">
          </a>
          <a href="https://twitter.com/CloudNativePg">
            <img src="/icons/Twitter.svg" alt="Twitter">
          </a>
          <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
            <img src="/icons/YouTube.svg" alt="YouTube">
          </a>
        </div>
      </div>
      

      <div class="flex gap-5 my-4 fill-cnp-blue hidden md:flex">
       <a class="github-button" href="https://github.com/cloudnative-pg/cloudnative-pg"
            data-color-scheme="no-preference: light; light: light; dark: dark;"
            data-size="large" data-show-count="true"
            aria-label="Star cloudnative-pg/cloudnative-pg on GitHub">Star</a>
        <a href="https://join.slack.com/t/cloudnativepg/shared_invite/zt-17culux7k-P_UsVOOR9teUYi4dGhDSBQ">
          <img src="/icons/Slack.svg" alt="Slack" title="Join our Slack channel now!">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>
<script>
  const toggleButton = document.getElementById('toggle-button')
  const naviList = document.getElementById('navi-list')

  toggleButton.addEventListener('click', () => {
    naviList.classList.toggle('hidden');
  })
</script>


    
<base href="..">
<div class="md:px-56 md:pt-20 md:flex">
    <div class="w-1/4 px-4 bg-purple-2 pt-14 leading-9 md:block hidden">
        
<ul>
    
    
    
    
    <li>
        <a href="/docs/v1.15.0/api_reference/">API Reference</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/applications/">Connecting from an application</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/architecture/">Architecture</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/backup_recovery/">Backup and Recovery</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/before_you_start/">Before You Start</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/bootstrap/">Bootstrap</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/certificates/">Certificates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/cnpg-plugin/">CloudNativePG Plugin</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/commercial_support/">Commercial support</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/connection_pooling/">Connection Pooling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/container_images/">Container Image Requirements</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/e2e/">End-to-End Tests</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/expose_pg_services/">Exposing Postgres Services</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failover/">Automated failover</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failure_modes/">Failure Modes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/fencing/">Fencing</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/installation_upgrade/">Installation and upgrades</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/instance_manager/">Postgres instance manager</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/kubernetes_upgrade/">Kubernetes Upgrade</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/labels_annotations/">Labels and annotations</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/logging/">Logging</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/monitoring/">Monitoring</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_capability_levels/">Operator Capability Levels</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_conf/">Operator configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/postgresql_conf/">PostgreSQL Configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/quickstart/">Quickstart</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/release_notes/">Release notes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/replication/">Replication</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/resource_management/">Resource management</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/rolling_update/">Rolling Updates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/samples/">Configuration Samples</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/scheduling/">Scheduling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/security/">Security</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/ssl_connections/">Client TLS/SSL Connections</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/storage/">Storage</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/supported_releases/">Supported releases</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/troubleshooting/">Troubleshooting</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/use_cases/">Use cases</a>
    </li>
    
    
    
</ul>

<hr class="w-1/2">


<p>Documention by version</p>
<ul>
    
    <li>
        <a href="/docs/v1.15.0/">
            CloudNativePG
            v1.15.0
        </a>
    </li>
    
</ul>

    </div>
    <div class="w-4/6 pr-20 ml-10 well hidden md:block">
        <p><h1 id="connection-pooling">Connection Pooling</h1>
<p>CloudNativePG provides native support for connection pooling with
<a href="https://www.pgbouncer.org/">PgBouncer</a>, one of the most popular open source
connection poolers for PostgreSQL, through the <code>Pooler</code> CRD.</p>
<p>In a nutshell, a <code>Pooler</code> in CloudNativePG is a deployment of
PgBouncer pods that sits between your applications and a PostgreSQL service
(for example the <code>rw</code> service), creating a separate, scalable, configurable,
and highly available <strong>database access layer</strong>.</p>
<h2 id="architecture">Architecture</h2>
<p>The following diagram highlights how the introduction of a database access
layer based on PgBouncer changes the architecture of CloudNativePG,
like an additional blade in a Swiss Army knife. Instead of directly connecting
to the PostgreSQL primary service, applications can now connect to the
equivalent service for PgBouncer, enabling reuse of existing connections for
faster performance and better resource management on the PostgreSQL side.</p>
<p><img src="./images/pgbouncer-architecture-rw.png" alt="Applications writing to the single primary via PgBouncer"></p>
<h2 id="quickstart">Quickstart</h2>
<p>The easiest way to explain how CloudNativePG implements a PgBouncer
pooler is through an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pgbouncer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">poolMode</span>: <span style="color:#ae81ff">session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_client_conn</span>: <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default_pool_size</span>: <span style="color:#e6db74">&#34;10&#34;</span>
</span></span></code></pre></div><p>!!! Important
Pooler name should never match with any Cluster name within the same namespace.</p>
<p>This creates a new <code>Pooler</code> resource called <code>pooler-example-rw</code> (the name is
arbitrary) that is strictly associated with the Postgres <code>Cluster</code> resource called
<code>cluster-example</code> and pointing to the primary, identified by the read/write
service (<code>rw</code>, therefore <code>cluster-example-rw</code>).</p>
<p>The <code>Pooler</code> must live in the same namespace of the Postgres cluster.
It consists of a Kubernetes deployment of 3 pods running the
<a href="https://ghcr.io/cloudnative-pg/pgbouncer">latest stable image of PgBouncer</a>,
configured with the <a href="https://www.pgbouncer.org/config.html#pool-mode"><code>session</code> pooling mode</a>
and accepting up to 1000 connections each - with a default pool size of 10
user/database pairs towards PostgreSQL.</p>
<p>!!! Important
The <code>Pooler</code> only sets the <code>*</code> fallback database in PgBouncer, meaning
that all parameters in the connection strings passed from the client are
relayed to the PostgreSQL server (please refer to <a href="https://www.pgbouncer.org/config.html#section-databases">&ldquo;Section [databases]&rdquo;
in PgBouncer&rsquo;s documentation</a>).</p>
<p>Additionally, CloudNativePG automatically creates a secret with the
same name of the pooler containing the configuration files used with PgBouncer.</p>
<p>!!! Seealso &ldquo;API reference&rdquo;
For details, please refer to <a href="api_reference.md#PgBouncerSpec"><code>PgBouncerSpec</code> section</a>
in the API reference.</p>
<h2 id="pooler-resource-lifecycle">Pooler resource lifecycle</h2>
<p><code>Pooler</code> resources are not <code>Cluster</code>-managed resources. You are supposed to
create poolers manually when they are needed. Additionally, you can deploy
multiple poolers per PostgreSQL Cluster.</p>
<p>What is important to note is that the lifecycles of the <code>Cluster</code> and the
<code>Pooler</code> resources are currently independent: the deletion of the <code>Cluster</code>
doesn&rsquo;t imply the automatic deletion of the <code>Pooler</code>, and viceversa.</p>
<p>!!! Important
Now that you know how a <code>Pooler</code> works, you have full freedom in terms of
possible architectures: you can have clusters without poolers, clusters with
a single pooler, or clusters with several poolers (i.e. one per application).</p>
<h2 id="security">Security</h2>
<p>Any PgBouncer pooler is transparently integrated with CloudNativePG
support for in-transit encryption via <strong>TLS connections</strong>, both on the client
(application) and server (PostgreSQL) side of the pool.</p>
<p>Specifically, PgBouncer automatically reuses the certificates of the PostgreSQL
server. Moreover, it uses TLS client certificate authentication to connect
to the PostgreSQL server to run the <code>auth_query</code> for clients&rsquo; password
authentication (see the <a href="#authentication">&ldquo;Authentication&rdquo; section</a> below).</p>
<p>Containers run as the <code>pgbouncer</code> system user, and access to the <code>pgbouncer</code>
database is only allowed via local connections, through <code>peer</code> authentication.</p>
<h3 id="certificates">Certificates</h3>
<p>By default, PgBouncer pooler will use the same certificates that are used by the
cluster itself, but if the user provides those certificates the pooler will accept
secrets with the following format:</p>
<ol>
<li>Basic Auth</li>
<li>TLS</li>
<li>Opaque</li>
</ol>
<p>In the Opaque case, it will look for specific keys that needs to be used, those keys
are the following:</p>
<ul>
<li>tls.crt</li>
<li>tls.key</li>
</ul>
<p>So we can treat this secret as a TLS secret, and start from there.</p>
<h2 id="authentication">Authentication</h2>
<p><strong>Password based authentication</strong> is the only supported method for clients of
PgBouncer in CloudNativePG.</p>
<p>Internally, our implementation relies on PgBouncer&rsquo;s <code>auth_user</code> and <code>auth_query</code> options. Specifically, the operator:</p>
<ul>
<li>creates a standard user called <code>cnpg_pooler_pgbouncer</code> in the PostgreSQL server</li>
<li>creates the lookup function in the <code>postgres</code> database and grants execution
privileges to the <code>cnpg_pooler_pgbouncer</code> user (PoLA)</li>
<li>issues a TLS certificate for this user</li>
<li>sets <code>cnpg_pooler_pgbouncer</code> as the <code>auth_user</code></li>
<li>configures PgBouncer to use the TLS certificate to authenticate
<code>cnpg_pooler_pgbouncer</code> against the PostgreSQL server</li>
<li>removes all the above when it detects that a cluster does not have
any pooler associated to it</li>
</ul>
<p>!!! Important
If you specify your own secrets the operator will not automatically integrate the Pooler.</p>
<p>To manually integrate the Pooler, in the case that you have specified your own secrets, you must run the following queries from inside your cluster.</p>
<ol>
<li>
<p>Create the role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">ROLE</span> cnpg_pooler_pgbouncer <span style="color:#66d9ef">WITH</span> LOGIN;
</span></span></code></pre></div></li>
<li>
<p>For each application database, grant the permission for <code>cnpg_pooler_pgbouncer</code> to connect to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">CONNECT</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#66d9ef">database</span> name here <span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#66d9ef">TO</span> cnpg_pooler_pgbouncer;
</span></span></code></pre></div></li>
<li>
<p>Connect in each application database, then create the authentication function inside each of the application databases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> user_search(uname TEXT) <span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">TABLE</span> (usename name, passwd text) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;SELECT usename, passwd FROM pg_shadow WHERE usename=$1;&#39;</span> <span style="color:#66d9ef">LANGUAGE</span> <span style="color:#66d9ef">sql</span> <span style="color:#66d9ef">SECURITY</span> <span style="color:#66d9ef">DEFINER</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">REVOKE</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">FUNCTION</span> user_search(text) <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">public</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">FUNCTION</span> user_search(text) <span style="color:#66d9ef">TO</span> cnpg_pooler_pgbouncer;
</span></span></code></pre></div></li>
</ol>
<h2 id="podtemplates">PodTemplates</h2>
<p>You can take advantage of pod templates specification in the <code>template</code>
section of a <code>Pooler</code> resource. For details, please refer to <a href="api_reference.md#PoolerSpec"><code>PoolerSpec</code>
section</a> in the API reference.</p>
<p>Through templates you can configure pods as you like, including fine
control over affinity and anti-affinity rules for pods and nodes.
By default, containers use images from <code>ghcr.io/cloudnative-pg/pgbouncer</code>.</p>
<p>Here an example of Pooler specifying PodAntiAffinity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>: []
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">topologyKey</span>: <span style="color:#e6db74">&#34;kubernetes.io/hostname&#34;</span>
</span></span></code></pre></div><p>!!! Note
<code>.spec.template.spec.containers</code> has to be explicitly set to <code>[]</code> when not modified, as it&rsquo;s a required field for a <code>PodSpec</code>.
If <code>.spec.template.spec.containers</code> is not set the kubernetes api-server will return the following error when trying to apply the manifest:
<code>error validating &quot;pooler.yaml&quot;: error validating data: ValidationError(Pooler.spec.template.spec): missing required field &quot;containers&quot;</code></p>
<p>Here an example setting resources and changing the used image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pgbouncer</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">my-pgbouncer:latest</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span></code></pre></div><h2 id="high-availability-ha">High Availability (HA)</h2>
<p>Thanks to Kubernetes&rsquo; deployments, you can configure your pooler to run
on a single instance or over multiple pods. The exposed service will
make sure that your clients are randomly distributed over the available
pods running PgBouncer - which will then automatically manage and reuse
connections towards the underlying server (if using the <code>rw</code> service)
or servers (if using the <code>ro</code> service with multiple replicas).</p>
<p>!!! Warning
Please be aware of network hops in case your infrastructure spans
multiple availability zones with high latency across them. Consider
for example the case of your application running in zone 2,
connecting to PgBouncer running in zone 3, pointing to the PostgreSQL
primary in zone 1.</p>
<h2 id="pgbouncer-configuration-options">PgBouncer configuration options</h2>
<p>The operator manages most of the <a href="https://www.pgbouncer.org/config.html">configuration options for PgBouncer</a>, allowing you to modify only a subset of them.</p>
<p>!!! Warning
You are responsible to correctly set the value of each option, as the operator
does not validate them.</p>
<p>Below you can find a list of the PgBouncer options you are allowed to
customize. Each of them contains a link to the PgBouncer documentation for that
specific parameter. Unless differently stated here, the default values are the
ones directly set by PgBouncer:</p>
<ul>
<li><a href="https://www.pgbouncer.org/config.html#application_name_add_host"><code>application_name_add_host</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#autodb_idle_timeout"><code>autodb_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_idle_timeout"><code>client_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_login_timeout"><code>client_login_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#default_pool_size"><code>default_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#disable_pqexec"><code>disable_pqexec</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#idle_transaction_timeout"><code>idle_transaction_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#ignore_startup_parameters"><code>ignore_startup_parameters</code></a>:
to be appended to <code>extra_float_digits,options</code> - required by CNP</li>
<li><a href="https://www.pgbouncer.org/config.html#log_connections"><code>log_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_disconnections"><code>log_disconnections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_pooler_errors"><code>log_pooler_errors</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_stats"><code>log_stats</code></a>: by default
disabled (<code>0</code>), given that statistics are already collected by the Prometheus
export as described in the <a href="#monitoring">&ldquo;Monitoring&rdquo;</a> section below</li>
<li><a href="https://www.pgbouncer.org/config.html#max_client_conn"><code>max_client_conn</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_db_connections"><code>max_db_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_user_connections"><code>max_user_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#min_pool_size"><code>min_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_timeout"><code>query_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_wait_timeout"><code>query_wait_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_size"><code>reserve_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_timeout"><code>reserve_pool_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_delay"><code>server_check_delay</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_query"><code>server_check_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_connect_timeout"><code>server_connect_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_fast_close"><code>server_fast_close</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_idle_timeout"><code>server_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_lifetime"><code>server_lifetime</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_login_retry"><code>server_login_retry</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query"><code>server_reset_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query_always"><code>server_reset_query_always</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_round_robin"><code>server_round_robin</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#stats_period"><code>stats_period</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#verbose"><code>verbose</code></a></li>
</ul>
<p>Customizations of the PgBouncer configuration are written
declaratively in the <code>.spec.pgbouncer.parameters</code> map.</p>
<p>The operator reacts to the changes in the Pooler specification,
and every PgBouncer instance reloads the updated configuration
without disrupting the service.</p>
<p>!!! Warning
Every PgBouncer pod will have the same configuration, aligned
with the parameters in the specification. A mistake in these
parameters could disrupt the operability of the <strong>whole Pooler</strong>.
The operator <strong>does not</strong> validate the value of any option.</p>
<h2 id="monitoring">Monitoring</h2>
<p>The PgBouncer implementation of the <code>Pooler</code> comes with a default
Prometheus exporter that automatically makes available several
metrics having the <code>cnpg_pgbouncer_</code> prefix, by running:</p>
<ul>
<li><code>SHOW LISTS</code> (prefix: <code>cnpg_pgbouncer_lists</code>)</li>
<li><code>SHOW POOLS</code> (prefix: <code>cnpg_pgbouncer_pools</code>)</li>
<li><code>SHOW STATS</code> (prefix: <code>cnpg_pgbouncer_stats</code>)</li>
</ul>
<p>Similarly to the CloudNativePG instance, the exporter runs on port
<code>9127</code> of each pod running PgBouncer, and also provides metrics related to the
Go runtime (with prefix <code>go_*</code>). You can debug the exporter on a pod running
PgBouncer through the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>kubectl exec -ti &lt;PGBOUNCER_POD&gt; -- curl 127.0.0.1:9127/metrics
</span></span></code></pre></div><p>An example of the output for <code>cnpg_pgbouncer</code> metrics:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># HELP cnpg_pgbouncer_collection_duration_seconds Collection time duration in seconds
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_collection_duration_seconds gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_collection_duration_seconds{collector=&#34;Collect.up&#34;} 0.002443168
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_collections_total Total number of times PostgreSQL was accessed for metrics.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_collections_total counter
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_collections_total 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_last_collection_error 1 if the last collection ended with error, 0 otherwise.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_last_collection_error gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_last_collection_error 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_databases Count of databases.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_databases gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_databases 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_names Count of DNS names in the cache.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_names gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_names 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_pending Not used.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_pending gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_pending 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_queries Count of in-flight DNS queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_queries gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_queries 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_zones Count of DNS zones in the cache.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_zones gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_zones 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_free_clients Count of free clients.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_free_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_free_clients 49
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_free_servers Count of free servers.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_free_servers gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_free_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_login_clients Count of clients in login state.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_login_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_login_clients 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_pools Count of pools.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_pools gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_pools 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_used_clients Count of used clients.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_used_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_used_clients 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_used_servers Count of used servers.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_used_servers gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_used_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_users Count of users.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_users gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_users 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_active Client connections that are linked to server connection and can process queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_active gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_cancel_req Client connections that have not forwarded query cancellations to the server yet.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_cancel_req gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_cancel_req{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_waiting Client connections that have sent queries but have not yet got a server connection.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_waiting gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_waiting{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_maxwait How long the first (oldest) client in the queue has waited, in seconds. If this starts increasing, then the current pool of servers does not handle requests quickly enough. The reason may be either an overloaded server or just too small of a pool_size setting.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_maxwait gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_maxwait{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_maxwait_us Microsecond part of the maximum waiting time.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_maxwait_us gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_maxwait_us{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_pool_mode The pooling mode in use. 1 for session, 2 for transaction, 3 for statement, -1 if unknown
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_pool_mode gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_pool_mode{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_active Server connections that are linked to a client.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_active gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_idle Server connections that are unused and immediately usable for client queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_idle gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_idle{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_login Server connections currently in the process of logging in.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_login gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_login{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_tested Server connections that are currently running either server_reset_query or server_check_query.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_tested gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_tested{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_used Server connections that have been idle for more than server_check_delay, so they need server_check_query to run on them before they can be used again.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_used gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_used{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_query_count Average queries per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_query_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_query_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_query_time Average query duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_query_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_recv Average received (from clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_recv gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_recv{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_sent Average sent (to clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_sent gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_wait_time Time spent by clients waiting for a server, in microseconds (average per second).
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_wait_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_xact_count Average transactions per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_xact_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_xact_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_xact_time Average transaction duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_xact_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_query_count Total number of SQL queries pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_query_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_query_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_query_time Total number of microseconds spent by pgbouncer when actively connected to PostgreSQL, executing queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_query_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_received Total volume in bytes of network traffic received by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_received gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_received{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_sent Total volume in bytes of network traffic sent by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_sent gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_wait_time Time spent by clients waiting for a server, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_wait_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_xact_count Total number of SQL transactions pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_xact_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_xact_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_xact_time Total number of microseconds spent by pgbouncer when connected to PostgreSQL in a transaction, either idle in transaction or executing queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_xact_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span></code></pre></div><p>Like for <code>Clusters</code>, if you are using the <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a>
you can configure it to scrape a specific Pooler by defining the following <a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodMonitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cnpg.io/poolerName</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">metrics</span>
</span></span></code></pre></div><h2 id="logging">Logging</h2>
<p>Logs are directly sent to standard output, in JSON format, like in the
following example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;info&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ts&#34;</span>: <span style="color:#960050;background-color:#1e0010">SECONDS.MICROSECONDS</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;record&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;pipe&#34;</span>: <span style="color:#e6db74">&#34;stderr&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;record&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;timestamp&#34;</span>: <span style="color:#e6db74">&#34;YYYY-MM-DD HH:MM:SS.MS UTC&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;pid&#34;</span>: <span style="color:#e6db74">&#34;&lt;PID&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;LOG&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;kernel file descriptor limit: 1048576 (hard: 1048576); max_client_conn: 100, max expected fd use: 112&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="pausing-connections">Pausing connections</h2>
<p>The <code>Pooler</code> specification allows you to take advantage of PgBouncer&rsquo;s <code>PAUSE</code>
and <code>RESUME</code> commands, using only declarative configuration - via the <code>paused</code>
option, by default set to <code>false</code>. When set to <code>true</code>, the operator internally
invokes the <code>PAUSE</code> command in PgBouncer, which:</p>
<ol>
<li>closes all active connections towards the PostgreSQL server, after waiting for the queries to complete</li>
<li>pauses any new connection coming from the client</li>
</ol>
<p>When the <code>paused</code> option is set back to <code>false</code>, the operator will invoke the
<code>RESUME</code> command in PgBouncer, re-opening the taps towards the PostgreSQL
service defined in the <code>Pooler</code>.</p>
<p>!!! Seealso &ldquo;PAUSE&rdquo;
For further information, please refer to the
<a href="https://www.pgbouncer.org/usage.html#pause-db"><code>PAUSE</code> section in the PgBouncer documentation</a>.</p>
<p>!!! Important
In future versions, the switchover operation will be fully integrated
with the PgBouncer pooler, and take advantage of the <code>PAUSE</code>/<code>RESUME</code>
features to reduce the perceived downtime by client applications.
At the moment, you can achieve the same results by setting the <code>paused</code>
attribute to <code>true</code>, then issuing the switchover command through the
<a href="cnpg-plugin.md#promote"><code>cnpg</code> plugin</a>, and finally restoring the <code>paused</code>
attribute to <code>false</code>.</p>
<h2 id="limitations">Limitations</h2>
<h3 id="single-postgresql-cluster">Single PostgreSQL cluster</h3>
<p>The current implementation of the pooler is designed to work as part of a
specific CloudNativePG cluster (a service, to be precise). It is not
possible at the moment to create a pooler that spans over multiple clusters.</p>
<h3 id="controlled-configurability">Controlled configurability</h3>
<p>CloudNativePG transparently manages several configuration options
that are used for the PgBouncer layer to communicate with PostgreSQL. Such
options are not configurable from outside and include TLS certificates,
authentication settings, <code>databases</code> section, and <code>users</code> section. Also,
considering the specific use case for the single PostgreSQL cluster, the
adopted criteria is to explicitly list the options that can be configured by
users.</p>
<p>!!! Note
We have reasons to believe that the adopted solution addresses the majority of
use cases, while leaving room for the future implementation of a separate
operator for PgBouncer to complete the gamma with more advanced and customized
scenarios.</p>
</p>
    </div>
    
    <div class="sticky top-0 px-4 bg-purple-2 leading-9 hidden md:hidden py-4" id="menu-list">
        
<ul>
    
    
    
    
    <li>
        <a href="/docs/v1.15.0/api_reference/">API Reference</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/applications/">Connecting from an application</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/architecture/">Architecture</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/backup_recovery/">Backup and Recovery</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/before_you_start/">Before You Start</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/bootstrap/">Bootstrap</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/certificates/">Certificates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/cnpg-plugin/">CloudNativePG Plugin</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/commercial_support/">Commercial support</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/connection_pooling/">Connection Pooling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/container_images/">Container Image Requirements</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/e2e/">End-to-End Tests</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/expose_pg_services/">Exposing Postgres Services</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failover/">Automated failover</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failure_modes/">Failure Modes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/fencing/">Fencing</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/installation_upgrade/">Installation and upgrades</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/instance_manager/">Postgres instance manager</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/kubernetes_upgrade/">Kubernetes Upgrade</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/labels_annotations/">Labels and annotations</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/logging/">Logging</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/monitoring/">Monitoring</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_capability_levels/">Operator Capability Levels</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_conf/">Operator configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/postgresql_conf/">PostgreSQL Configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/quickstart/">Quickstart</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/release_notes/">Release notes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/replication/">Replication</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/resource_management/">Resource management</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/rolling_update/">Rolling Updates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/samples/">Configuration Samples</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/scheduling/">Scheduling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/security/">Security</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/ssl_connections/">Client TLS/SSL Connections</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/storage/">Storage</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/supported_releases/">Supported releases</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/troubleshooting/">Troubleshooting</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/use_cases/">Use cases</a>
    </li>
    
    
    
</ul>

<hr class="w-1/2">


<p>Documention by version</p>
<ul>
    
    <li>
        <a href="/docs/v1.15.0/">
            CloudNativePG
            v1.15.0
        </a>
    </li>
    
</ul>

    </div>
    <div class="px-4 well md:hidden">
        <p><h1 id="connection-pooling">Connection Pooling</h1>
<p>CloudNativePG provides native support for connection pooling with
<a href="https://www.pgbouncer.org/">PgBouncer</a>, one of the most popular open source
connection poolers for PostgreSQL, through the <code>Pooler</code> CRD.</p>
<p>In a nutshell, a <code>Pooler</code> in CloudNativePG is a deployment of
PgBouncer pods that sits between your applications and a PostgreSQL service
(for example the <code>rw</code> service), creating a separate, scalable, configurable,
and highly available <strong>database access layer</strong>.</p>
<h2 id="architecture">Architecture</h2>
<p>The following diagram highlights how the introduction of a database access
layer based on PgBouncer changes the architecture of CloudNativePG,
like an additional blade in a Swiss Army knife. Instead of directly connecting
to the PostgreSQL primary service, applications can now connect to the
equivalent service for PgBouncer, enabling reuse of existing connections for
faster performance and better resource management on the PostgreSQL side.</p>
<p><img src="./images/pgbouncer-architecture-rw.png" alt="Applications writing to the single primary via PgBouncer"></p>
<h2 id="quickstart">Quickstart</h2>
<p>The easiest way to explain how CloudNativePG implements a PgBouncer
pooler is through an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pgbouncer</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">poolMode</span>: <span style="color:#ae81ff">session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_client_conn</span>: <span style="color:#e6db74">&#34;1000&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">default_pool_size</span>: <span style="color:#e6db74">&#34;10&#34;</span>
</span></span></code></pre></div><p>!!! Important
Pooler name should never match with any Cluster name within the same namespace.</p>
<p>This creates a new <code>Pooler</code> resource called <code>pooler-example-rw</code> (the name is
arbitrary) that is strictly associated with the Postgres <code>Cluster</code> resource called
<code>cluster-example</code> and pointing to the primary, identified by the read/write
service (<code>rw</code>, therefore <code>cluster-example-rw</code>).</p>
<p>The <code>Pooler</code> must live in the same namespace of the Postgres cluster.
It consists of a Kubernetes deployment of 3 pods running the
<a href="https://ghcr.io/cloudnative-pg/pgbouncer">latest stable image of PgBouncer</a>,
configured with the <a href="https://www.pgbouncer.org/config.html#pool-mode"><code>session</code> pooling mode</a>
and accepting up to 1000 connections each - with a default pool size of 10
user/database pairs towards PostgreSQL.</p>
<p>!!! Important
The <code>Pooler</code> only sets the <code>*</code> fallback database in PgBouncer, meaning
that all parameters in the connection strings passed from the client are
relayed to the PostgreSQL server (please refer to <a href="https://www.pgbouncer.org/config.html#section-databases">&ldquo;Section [databases]&rdquo;
in PgBouncer&rsquo;s documentation</a>).</p>
<p>Additionally, CloudNativePG automatically creates a secret with the
same name of the pooler containing the configuration files used with PgBouncer.</p>
<p>!!! Seealso &ldquo;API reference&rdquo;
For details, please refer to <a href="api_reference.md#PgBouncerSpec"><code>PgBouncerSpec</code> section</a>
in the API reference.</p>
<h2 id="pooler-resource-lifecycle">Pooler resource lifecycle</h2>
<p><code>Pooler</code> resources are not <code>Cluster</code>-managed resources. You are supposed to
create poolers manually when they are needed. Additionally, you can deploy
multiple poolers per PostgreSQL Cluster.</p>
<p>What is important to note is that the lifecycles of the <code>Cluster</code> and the
<code>Pooler</code> resources are currently independent: the deletion of the <code>Cluster</code>
doesn&rsquo;t imply the automatic deletion of the <code>Pooler</code>, and viceversa.</p>
<p>!!! Important
Now that you know how a <code>Pooler</code> works, you have full freedom in terms of
possible architectures: you can have clusters without poolers, clusters with
a single pooler, or clusters with several poolers (i.e. one per application).</p>
<h2 id="security">Security</h2>
<p>Any PgBouncer pooler is transparently integrated with CloudNativePG
support for in-transit encryption via <strong>TLS connections</strong>, both on the client
(application) and server (PostgreSQL) side of the pool.</p>
<p>Specifically, PgBouncer automatically reuses the certificates of the PostgreSQL
server. Moreover, it uses TLS client certificate authentication to connect
to the PostgreSQL server to run the <code>auth_query</code> for clients&rsquo; password
authentication (see the <a href="#authentication">&ldquo;Authentication&rdquo; section</a> below).</p>
<p>Containers run as the <code>pgbouncer</code> system user, and access to the <code>pgbouncer</code>
database is only allowed via local connections, through <code>peer</code> authentication.</p>
<h3 id="certificates">Certificates</h3>
<p>By default, PgBouncer pooler will use the same certificates that are used by the
cluster itself, but if the user provides those certificates the pooler will accept
secrets with the following format:</p>
<ol>
<li>Basic Auth</li>
<li>TLS</li>
<li>Opaque</li>
</ol>
<p>In the Opaque case, it will look for specific keys that needs to be used, those keys
are the following:</p>
<ul>
<li>tls.crt</li>
<li>tls.key</li>
</ul>
<p>So we can treat this secret as a TLS secret, and start from there.</p>
<h2 id="authentication">Authentication</h2>
<p><strong>Password based authentication</strong> is the only supported method for clients of
PgBouncer in CloudNativePG.</p>
<p>Internally, our implementation relies on PgBouncer&rsquo;s <code>auth_user</code> and <code>auth_query</code> options. Specifically, the operator:</p>
<ul>
<li>creates a standard user called <code>cnpg_pooler_pgbouncer</code> in the PostgreSQL server</li>
<li>creates the lookup function in the <code>postgres</code> database and grants execution
privileges to the <code>cnpg_pooler_pgbouncer</code> user (PoLA)</li>
<li>issues a TLS certificate for this user</li>
<li>sets <code>cnpg_pooler_pgbouncer</code> as the <code>auth_user</code></li>
<li>configures PgBouncer to use the TLS certificate to authenticate
<code>cnpg_pooler_pgbouncer</code> against the PostgreSQL server</li>
<li>removes all the above when it detects that a cluster does not have
any pooler associated to it</li>
</ul>
<p>!!! Important
If you specify your own secrets the operator will not automatically integrate the Pooler.</p>
<p>To manually integrate the Pooler, in the case that you have specified your own secrets, you must run the following queries from inside your cluster.</p>
<ol>
<li>
<p>Create the role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">ROLE</span> cnpg_pooler_pgbouncer <span style="color:#66d9ef">WITH</span> LOGIN;
</span></span></code></pre></div></li>
<li>
<p>For each application database, grant the permission for <code>cnpg_pooler_pgbouncer</code> to connect to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">CONNECT</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#66d9ef">database</span> name here <span style="color:#960050;background-color:#1e0010">}</span> <span style="color:#66d9ef">TO</span> cnpg_pooler_pgbouncer;
</span></span></code></pre></div></li>
<li>
<p>Connect in each application database, then create the authentication function inside each of the application databases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> user_search(uname TEXT) <span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">TABLE</span> (usename name, passwd text) <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;SELECT usename, passwd FROM pg_shadow WHERE usename=$1;&#39;</span> <span style="color:#66d9ef">LANGUAGE</span> <span style="color:#66d9ef">sql</span> <span style="color:#66d9ef">SECURITY</span> <span style="color:#66d9ef">DEFINER</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">REVOKE</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">FUNCTION</span> user_search(text) <span style="color:#66d9ef">FROM</span> <span style="color:#66d9ef">public</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GRANT</span> <span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">ON</span> <span style="color:#66d9ef">FUNCTION</span> user_search(text) <span style="color:#66d9ef">TO</span> cnpg_pooler_pgbouncer;
</span></span></code></pre></div></li>
</ol>
<h2 id="podtemplates">PodTemplates</h2>
<p>You can take advantage of pod templates specification in the <code>template</code>
section of a <code>Pooler</code> resource. For details, please refer to <a href="api_reference.md#PoolerSpec"><code>PoolerSpec</code>
section</a> in the API reference.</p>
<p>Through templates you can configure pods as you like, including fine
control over affinity and anti-affinity rules for pods and nodes.
By default, containers use images from <code>ghcr.io/cloudnative-pg/pgbouncer</code>.</p>
<p>Here an example of Pooler specifying PodAntiAffinity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>: []
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">affinity</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">podAntiAffinity</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>              - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">app</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">topologyKey</span>: <span style="color:#e6db74">&#34;kubernetes.io/hostname&#34;</span>
</span></span></code></pre></div><p>!!! Note
<code>.spec.template.spec.containers</code> has to be explicitly set to <code>[]</code> when not modified, as it&rsquo;s a required field for a <code>PodSpec</code>.
If <code>.spec.template.spec.containers</code> is not set the kubernetes api-server will return the following error when trying to apply the manifest:
<code>error validating &quot;pooler.yaml&quot;: error validating data: ValidationError(Pooler.spec.template.spec): missing required field &quot;containers&quot;</code></p>
<p>Here an example setting resources and changing the used image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pooler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pooler-example-rw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rw</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">pooler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pgbouncer</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">my-pgbouncer:latest</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">limits</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">500Mi</span>
</span></span></code></pre></div><h2 id="high-availability-ha">High Availability (HA)</h2>
<p>Thanks to Kubernetes&rsquo; deployments, you can configure your pooler to run
on a single instance or over multiple pods. The exposed service will
make sure that your clients are randomly distributed over the available
pods running PgBouncer - which will then automatically manage and reuse
connections towards the underlying server (if using the <code>rw</code> service)
or servers (if using the <code>ro</code> service with multiple replicas).</p>
<p>!!! Warning
Please be aware of network hops in case your infrastructure spans
multiple availability zones with high latency across them. Consider
for example the case of your application running in zone 2,
connecting to PgBouncer running in zone 3, pointing to the PostgreSQL
primary in zone 1.</p>
<h2 id="pgbouncer-configuration-options">PgBouncer configuration options</h2>
<p>The operator manages most of the <a href="https://www.pgbouncer.org/config.html">configuration options for PgBouncer</a>, allowing you to modify only a subset of them.</p>
<p>!!! Warning
You are responsible to correctly set the value of each option, as the operator
does not validate them.</p>
<p>Below you can find a list of the PgBouncer options you are allowed to
customize. Each of them contains a link to the PgBouncer documentation for that
specific parameter. Unless differently stated here, the default values are the
ones directly set by PgBouncer:</p>
<ul>
<li><a href="https://www.pgbouncer.org/config.html#application_name_add_host"><code>application_name_add_host</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#autodb_idle_timeout"><code>autodb_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_idle_timeout"><code>client_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#client_login_timeout"><code>client_login_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#default_pool_size"><code>default_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#disable_pqexec"><code>disable_pqexec</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#idle_transaction_timeout"><code>idle_transaction_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#ignore_startup_parameters"><code>ignore_startup_parameters</code></a>:
to be appended to <code>extra_float_digits,options</code> - required by CNP</li>
<li><a href="https://www.pgbouncer.org/config.html#log_connections"><code>log_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_disconnections"><code>log_disconnections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_pooler_errors"><code>log_pooler_errors</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#log_stats"><code>log_stats</code></a>: by default
disabled (<code>0</code>), given that statistics are already collected by the Prometheus
export as described in the <a href="#monitoring">&ldquo;Monitoring&rdquo;</a> section below</li>
<li><a href="https://www.pgbouncer.org/config.html#max_client_conn"><code>max_client_conn</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_db_connections"><code>max_db_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#max_user_connections"><code>max_user_connections</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#min_pool_size"><code>min_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_timeout"><code>query_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#query_wait_timeout"><code>query_wait_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_size"><code>reserve_pool_size</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#reserve_pool_timeout"><code>reserve_pool_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_delay"><code>server_check_delay</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_check_query"><code>server_check_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_connect_timeout"><code>server_connect_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_fast_close"><code>server_fast_close</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_idle_timeout"><code>server_idle_timeout</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_lifetime"><code>server_lifetime</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_login_retry"><code>server_login_retry</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query"><code>server_reset_query</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_reset_query_always"><code>server_reset_query_always</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#server_round_robin"><code>server_round_robin</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#stats_period"><code>stats_period</code></a></li>
<li><a href="https://www.pgbouncer.org/config.html#verbose"><code>verbose</code></a></li>
</ul>
<p>Customizations of the PgBouncer configuration are written
declaratively in the <code>.spec.pgbouncer.parameters</code> map.</p>
<p>The operator reacts to the changes in the Pooler specification,
and every PgBouncer instance reloads the updated configuration
without disrupting the service.</p>
<p>!!! Warning
Every PgBouncer pod will have the same configuration, aligned
with the parameters in the specification. A mistake in these
parameters could disrupt the operability of the <strong>whole Pooler</strong>.
The operator <strong>does not</strong> validate the value of any option.</p>
<h2 id="monitoring">Monitoring</h2>
<p>The PgBouncer implementation of the <code>Pooler</code> comes with a default
Prometheus exporter that automatically makes available several
metrics having the <code>cnpg_pgbouncer_</code> prefix, by running:</p>
<ul>
<li><code>SHOW LISTS</code> (prefix: <code>cnpg_pgbouncer_lists</code>)</li>
<li><code>SHOW POOLS</code> (prefix: <code>cnpg_pgbouncer_pools</code>)</li>
<li><code>SHOW STATS</code> (prefix: <code>cnpg_pgbouncer_stats</code>)</li>
</ul>
<p>Similarly to the CloudNativePG instance, the exporter runs on port
<code>9127</code> of each pod running PgBouncer, and also provides metrics related to the
Go runtime (with prefix <code>go_*</code>). You can debug the exporter on a pod running
PgBouncer through the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>kubectl exec -ti &lt;PGBOUNCER_POD&gt; -- curl 127.0.0.1:9127/metrics
</span></span></code></pre></div><p>An example of the output for <code>cnpg_pgbouncer</code> metrics:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># HELP cnpg_pgbouncer_collection_duration_seconds Collection time duration in seconds
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_collection_duration_seconds gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_collection_duration_seconds{collector=&#34;Collect.up&#34;} 0.002443168
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_collections_total Total number of times PostgreSQL was accessed for metrics.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_collections_total counter
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_collections_total 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_last_collection_error 1 if the last collection ended with error, 0 otherwise.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_last_collection_error gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_last_collection_error 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_databases Count of databases.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_databases gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_databases 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_names Count of DNS names in the cache.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_names gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_names 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_pending Not used.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_pending gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_pending 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_queries Count of in-flight DNS queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_queries gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_queries 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_dns_zones Count of DNS zones in the cache.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_dns_zones gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_dns_zones 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_free_clients Count of free clients.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_free_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_free_clients 49
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_free_servers Count of free servers.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_free_servers gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_free_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_login_clients Count of clients in login state.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_login_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_login_clients 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_pools Count of pools.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_pools gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_pools 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_used_clients Count of used clients.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_used_clients gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_used_clients 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_used_servers Count of used servers.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_used_servers gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_used_servers 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_lists_users Count of users.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_lists_users gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_lists_users 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_active Client connections that are linked to server connection and can process queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_active gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_cancel_req Client connections that have not forwarded query cancellations to the server yet.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_cancel_req gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_cancel_req{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_cl_waiting Client connections that have sent queries but have not yet got a server connection.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_cl_waiting gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_cl_waiting{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_maxwait How long the first (oldest) client in the queue has waited, in seconds. If this starts increasing, then the current pool of servers does not handle requests quickly enough. The reason may be either an overloaded server or just too small of a pool_size setting.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_maxwait gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_maxwait{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_maxwait_us Microsecond part of the maximum waiting time.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_maxwait_us gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_maxwait_us{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_pool_mode The pooling mode in use. 1 for session, 2 for transaction, 3 for statement, -1 if unknown
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_pool_mode gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_pool_mode{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_active Server connections that are linked to a client.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_active gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_active{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_idle Server connections that are unused and immediately usable for client queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_idle gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_idle{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_login Server connections currently in the process of logging in.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_login gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_login{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_tested Server connections that are currently running either server_reset_query or server_check_query.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_tested gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_tested{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_pools_sv_used Server connections that have been idle for more than server_check_delay, so they need server_check_query to run on them before they can be used again.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_pools_sv_used gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_pools_sv_used{database=&#34;pgbouncer&#34;,user=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_query_count Average queries per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_query_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_query_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_query_time Average query duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_query_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_recv Average received (from clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_recv gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_recv{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_sent Average sent (to clients) bytes per second.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_sent gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_wait_time Time spent by clients waiting for a server, in microseconds (average per second).
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_wait_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_xact_count Average transactions per second in last stat period.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_xact_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_xact_count{database=&#34;pgbouncer&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_avg_xact_time Average transaction duration, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_avg_xact_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_avg_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_query_count Total number of SQL queries pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_query_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_query_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_query_time Total number of microseconds spent by pgbouncer when actively connected to PostgreSQL, executing queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_query_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_query_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_received Total volume in bytes of network traffic received by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_received gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_received{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_sent Total volume in bytes of network traffic sent by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_sent gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_sent{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_wait_time Time spent by clients waiting for a server, in microseconds.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_wait_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_wait_time{database=&#34;pgbouncer&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_xact_count Total number of SQL transactions pooled by pgbouncer.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_xact_count gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_xact_count{database=&#34;pgbouncer&#34;} 3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_pgbouncer_stats_total_xact_time Total number of microseconds spent by pgbouncer when connected to PostgreSQL in a transaction, either idle in transaction or executing queries.
</span></span><span style="display:flex;"><span># TYPE cnpg_pgbouncer_stats_total_xact_time gauge
</span></span><span style="display:flex;"><span>cnpg_pgbouncer_stats_total_xact_time{database=&#34;pgbouncer&#34;} 0
</span></span></code></pre></div><p>Like for <code>Clusters</code>, if you are using the <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a>
you can configure it to scrape a specific Pooler by defining the following <a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodMonitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cnpg.io/poolerName</span>: <span style="color:#ae81ff">&lt;POOLER_NAME&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">metrics</span>
</span></span></code></pre></div><h2 id="logging">Logging</h2>
<p>Logs are directly sent to standard output, in JSON format, like in the
following example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;info&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ts&#34;</span>: <span style="color:#960050;background-color:#1e0010">SECONDS.MICROSECONDS</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;record&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;pipe&#34;</span>: <span style="color:#e6db74">&#34;stderr&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;record&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;timestamp&#34;</span>: <span style="color:#e6db74">&#34;YYYY-MM-DD HH:MM:SS.MS UTC&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;pid&#34;</span>: <span style="color:#e6db74">&#34;&lt;PID&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;LOG&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;msg&#34;</span>: <span style="color:#e6db74">&#34;kernel file descriptor limit: 1048576 (hard: 1048576); max_client_conn: 100, max expected fd use: 112&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="pausing-connections">Pausing connections</h2>
<p>The <code>Pooler</code> specification allows you to take advantage of PgBouncer&rsquo;s <code>PAUSE</code>
and <code>RESUME</code> commands, using only declarative configuration - via the <code>paused</code>
option, by default set to <code>false</code>. When set to <code>true</code>, the operator internally
invokes the <code>PAUSE</code> command in PgBouncer, which:</p>
<ol>
<li>closes all active connections towards the PostgreSQL server, after waiting for the queries to complete</li>
<li>pauses any new connection coming from the client</li>
</ol>
<p>When the <code>paused</code> option is set back to <code>false</code>, the operator will invoke the
<code>RESUME</code> command in PgBouncer, re-opening the taps towards the PostgreSQL
service defined in the <code>Pooler</code>.</p>
<p>!!! Seealso &ldquo;PAUSE&rdquo;
For further information, please refer to the
<a href="https://www.pgbouncer.org/usage.html#pause-db"><code>PAUSE</code> section in the PgBouncer documentation</a>.</p>
<p>!!! Important
In future versions, the switchover operation will be fully integrated
with the PgBouncer pooler, and take advantage of the <code>PAUSE</code>/<code>RESUME</code>
features to reduce the perceived downtime by client applications.
At the moment, you can achieve the same results by setting the <code>paused</code>
attribute to <code>true</code>, then issuing the switchover command through the
<a href="cnpg-plugin.md#promote"><code>cnpg</code> plugin</a>, and finally restoring the <code>paused</code>
attribute to <code>false</code>.</p>
<h2 id="limitations">Limitations</h2>
<h3 id="single-postgresql-cluster">Single PostgreSQL cluster</h3>
<p>The current implementation of the pooler is designed to work as part of a
specific CloudNativePG cluster (a service, to be precise). It is not
possible at the moment to create a pooler that spans over multiple clusters.</p>
<h3 id="controlled-configurability">Controlled configurability</h3>
<p>CloudNativePG transparently manages several configuration options
that are used for the PgBouncer layer to communicate with PostgreSQL. Such
options are not configurable from outside and include TLS certificates,
authentication settings, <code>databases</code> section, and <code>users</code> section. Also,
considering the specific use case for the single PostgreSQL cluster, the
adopted criteria is to explicitly list the options that can be configured by
users.</p>
<p>!!! Note
We have reasons to believe that the adopted solution addresses the majority of
use cases, while leaving room for the future implementation of a separate
operator for PgBouncer to complete the gamma with more advanced and customized
scenarios.</p>
</p>
    </div>
    
</div>

<div class="flex gap-3 bg-gray-1 px-4 py-4 cnp-blue md:hidden fixed bottom-0 w-full" id="menu-toggle">
    <img src="/icons/menu-unfold-outlined.svg" alt="">
    <h4 class="text-lg">Documentation</h4>
</div>

<script>
    const menuToggle = document.getElementById('menu-toggle')
    const menuList = document.getElementById('menu-list')
  
    menuToggle.addEventListener('click', () => {
      menuList.classList.toggle('hidden');
    })
</script>


    <footer class="text-center pb-24">
    <p class="text-sm charcoal md:w-1/2 mx-auto md:pt-10 px-6 pt-12">

      &copy; The CloudNativePG Contributors.<br />

      <a href="https://www.linuxfoundation.org/trademark-usage/"
        class="red-1">The Linux Foundation has registered trademarks and uses
        trademarks</a>.<br />

      <a href="https://www.postgresql.org/about/policies/trademarks"
        class="red-1">Postgres, PostgreSQL and the Slonik Logo are trademarks or
        registered trademarks of the PostgreSQL Community Association of Canada, and
        used with their permission</a>.

    </p>
</footer>

  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>
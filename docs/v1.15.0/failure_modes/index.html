<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link rel="preload" href="/css/Supreme-Variable.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
  <link rel="favicon" href="/favicon/favicon.ico">
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="md:flex md:flex-row md:px-16 md:justify-between py-5">
      <div class="flex justify-between px-4 md:hidden">
        <div>
          
          <a href="/"><img src="/logo/large_logo.svg" class="md:h-14 h-9" alt="Cloud Native Postgres Logo"></a>
        </div>
        <div class="h-6 my-auto" id="toggle-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </div>
      </div>
      <div class="md:block hidden">
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      
      <div class="hidden md:block">
        <ul class="md:flex gap-14 text-2xl medium-gray my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Blog</li>
          <li><a href="/support">Support</a></li>
          <li><a href="/end_users">End Users</a></li>
        </ul>
      </div>
      
      <div class="py-4 bg-gray-1 mt-5 hidden" id="navi-list">
        <ul class="md:flex gap-14 text-2xl md:medium-gray charcoal">
          <li class="text-center py-4"><a href="/docs">Documentation</a></li>
          <li class="text-center py-4"><a href="/blog">Blog</a></li>
          <li class="text-center py-4"><a href="/support">Support</a></li>
          <li class="text-center py-4"><a href="/end_users">End Users</a></li>
        </ul>
        <div class="flex gap-3 py-4 justify-center bg-gray-1 fill-cnp-blue">
          <a href="https://github.com/cloudnative-pg/cloudnative-pg">
            <img src="/icons/Git.svg" alt="Github">
          </a>
          <a href="https://cloudnativepg.slack.com/">
            <img src="/icons/Slack.svg" alt="Slack">
          </a>
          <a href="https://twitter.com/CloudNativePg">
            <img src="/icons/Twitter.svg" alt="Twitter">
          </a>
          <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
            <img src="/icons/YouTube.svg" alt="YouTube">
          </a>
        </div>
      </div>
      

      <div class="flex gap-5 my-4 fill-cnp-blue hidden md:flex">
       <a class="github-button" href="https://github.com/cloudnative-pg/cloudnative-pg"
            data-color-scheme="no-preference: light; light: light; dark: dark;"
            data-size="large" data-show-count="true"
            aria-label="Star cloudnative-pg/cloudnative-pg on GitHub">Star</a>
        <a href="https://join.slack.com/t/cloudnativepg/shared_invite/zt-17culux7k-P_UsVOOR9teUYi4dGhDSBQ">
          <img src="/icons/Slack.svg" alt="Slack" title="Join our Slack channel now!">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>
<script>
  const toggleButton = document.getElementById('toggle-button')
  const naviList = document.getElementById('navi-list')

  toggleButton.addEventListener('click', () => {
    naviList.classList.toggle('hidden');
  })
</script>


    
<base href="..">
<div class="px-56 pt-20 flex">
    <div class="w-1/4 px-5 bg-purple-2 pt-14 leading-9">
        
<ul>
    
    
    
    
    <li>
        <a href="/docs/v1.15.0/api_reference/">API Reference</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/applications/">Connecting from an application</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/architecture/">Architecture</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/backup_recovery/">Backup and Recovery</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/before_you_start/">Before You Start</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/bootstrap/">Bootstrap</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/certificates/">Certificates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/cnpg-plugin/">CloudNativePG Plugin</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/commercial_support/">Commercial support</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/connection_pooling/">Connection Pooling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/container_images/">Container Image Requirements</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/e2e/">End-to-End Tests</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/expose_pg_services/">Exposing Postgres Services</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failover/">Automated failover</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failure_modes/">Failure Modes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/fencing/">Fencing</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/installation_upgrade/">Installation and upgrades</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/instance_manager/">Postgres instance manager</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/kubernetes_upgrade/">Kubernetes Upgrade</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/labels_annotations/">Labels and annotations</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/logging/">Logging</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/monitoring/">Monitoring</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_capability_levels/">Operator Capability Levels</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_conf/">Operator configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/postgresql_conf/">PostgreSQL Configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/quickstart/">Quickstart</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/release_notes/">Release notes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/replication/">Replication</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/resource_management/">Resource management</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/rolling_update/">Rolling Updates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/samples/">Configuration Samples</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/scheduling/">Scheduling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/security/">Security</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/ssl_connections/">Client TLS/SSL Connections</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/storage/">Storage</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/supported_releases/">Supported releases</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/troubleshooting/">Troubleshooting</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/use_cases/">Use cases</a>
    </li>
    
    
    
</ul>

<hr class="w-1/2">


<p>Documention by version</p>
<ul>
    
    <li>
        <a href="/docs/v1.15.0/">
            CloudNativePG
            v1.15.0
        </a>
    </li>
    
</ul>

    </div>
    <div class="w-4/6 pr-20 ml-10 well">
        <p><h1 id="failure-modes">Failure Modes</h1>
<p>This section provides an overview of the major failure scenarios that
PostgreSQL can face on a Kubernetes cluster during its lifetime.</p>
<p>!!! Important
In case the failure scenario you are experiencing is not covered by this
section, please immediately contact EDB for support and assistance.</p>
<p>!!! Seealso &ldquo;Postgres instance manager&rdquo;
Please refer to the <a href="instance_manager.md">&ldquo;Postgres instance manager&rdquo; section</a>
for more information the liveness and readiness probes implemented by
CloudNativePG.</p>
<h2 id="storage-space-usage">Storage space usage</h2>
<p>The operator will instantiate one PVC for every PostgreSQL instance to store the <code>PGDATA</code> content.</p>
<p>Such storage space is set for reuse in two cases:</p>
<ul>
<li>when the corresponding Pod is deleted by the user (and a new Pod will be recreated)</li>
<li>when the corresponding Pod is evicted and scheduled on another node</li>
</ul>
<p>If you want to prevent the operator from reusing a certain PVC you need to
remove the PVC before deleting the Pod. For this purpose, you can use the
following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl delete -n <span style="color:#f92672">[</span>namespace<span style="color:#f92672">]</span> pvc/<span style="color:#f92672">[</span>cluster-name<span style="color:#f92672">]</span>-<span style="color:#f92672">[</span>serial<span style="color:#f92672">]</span> pod/<span style="color:#f92672">[</span>cluster-name<span style="color:#f92672">]</span>-<span style="color:#f92672">[</span>serial<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ kubectl delete -n default pvc/cluster-example-1 pod/cluster-example-1
</span></span><span style="display:flex;"><span>persistentvolumeclaim <span style="color:#e6db74">&#34;cluster-example-1&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;cluster-example-1&#34;</span> deleted
</span></span></code></pre></div><h2 id="failure-modes-1">Failure modes</h2>
<p>A pod belonging to a <code>Cluster</code> can fail in the following ways:</p>
<ul>
<li>the pod is explicitly deleted by the user;</li>
<li>the readiness probe on its <code>postgres</code> container fails;</li>
<li>the liveness probe on its <code>postgres</code> container fails;</li>
<li>the Kubernetes worker node is drained;</li>
<li>the Kubernetes worker node where the pod is scheduled fails.</li>
</ul>
<p>Each one of these failures has different effects on the <code>Cluster</code> and the
services managed by the operator.</p>
<h3 id="pod-deleted-by-the-user">Pod deleted by the user</h3>
<p>The operator is notified of the deletion. A new pod belonging to the
<code>Cluster</code> will be automatically created reusing the existing PVC, if available,
or starting from a physical backup of the <em>primary</em> otherwise.</p>
<p>!!! Important
In case of deliberate deletion of a pod, <code>PodDisruptionBudget</code> policies
will not be enforced.</p>
<p>Self-healing will happen as soon as the <em>apiserver</em> is notified.</p>
<h3 id="readiness-probe-failure">Readiness probe failure</h3>
<p>After 3 failures, the pod will be considered <em>not ready</em>. The pod will still
be part of the <code>Cluster</code>, no new pod will be created.</p>
<p>If the cause of the failure can&rsquo;t be fixed, it is possible to delete the pod
manually. Otherwise, the pod will resume the previous role when the failure
is solved.</p>
<p>Self-healing will happen after three failures of the probe.</p>
<h3 id="liveness-probe-failure">Liveness probe failure</h3>
<p>After 3 failures, the <code>postgres</code> container will be considered failed. The
pod will still be part of the <code>Cluster</code>, and the <em>kubelet</em> will try to restart
the container. If the cause of the failure can&rsquo;t be fixed, it is possible
to delete the pod manually.</p>
<p>Self-healing will happen after three failures of the probe.</p>
<h3 id="worker-node-drained">Worker node drained</h3>
<p>The pod will be evicted from the worker node and removed from the service. A
new pod will be created on a different worker node from a physical backup of the
<em>primary</em> if the <code>reusePVC</code> option of the <code>nodeMaintenanceWindow</code> parameter
is set to <code>off</code> (default: <code>on</code> during maintenance windows, <code>off</code> otherwise).</p>
<p>The <code>PodDisruptionBudget</code> may prevent the pod from being evicted if there
is at least another pod that is not ready.</p>
<p>!!! Note
Single instance clusters prevent node drain when <code>reusePVC</code> is
set to <code>false</code>. Refer to the <a href="kubernetes_upgrade.md">Kubernetes Upgrade section</a>.</p>
<p>Self-healing will happen as soon as the <em>apiserver</em> is notified.</p>
<h3 id="worker-node-failure">Worker node failure</h3>
<p>Since the node is failed, the <em>kubelet</em> won&rsquo;t execute the liveness and
the readiness probes. The pod will be marked for deletion after the
toleration seconds configured by the Kubernetes cluster administrator for
that specific failure cause. Based on how the Kubernetes cluster is configured,
the pod might be removed from the service earlier.</p>
<p>A new pod will be created on a different worker node from a physical backup
of the <em>primary</em>. The default value for that parameter in a Kubernetes
cluster is 5 minutes.</p>
<p>Self-healing will happen after <code>tolerationSeconds</code>.</p>
<h2 id="self-healing">Self-healing</h2>
<p>If the failed pod is a standby, the pod is removed from the <code>-r</code> service
and from the <code>-ro</code> service.
The pod is then restarted using its PVC if available; otherwise, a new
pod will be created from a backup of the current primary. The pod
will be added again to the <code>-r</code> service and to the <code>-ro</code> service when ready.</p>
<p>If the failed pod is the primary, the operator will promote the active pod
with status ready and the lowest replication lag, then point the <code>-rw</code> service
to it. The failed pod will be removed from the <code>-r</code> service and from the
<code>-rw</code> service.
Other standbys will start replicating from the new primary. The former
primary will use <code>pg_rewind</code> to synchronize itself with the new one if its
PVC is available; otherwise, a new standby will be created from a backup of the
current primary.</p>
<h2 id="manual-intervention">Manual intervention</h2>
<p>In the case of undocumented failure, it might be necessary to intervene
to solve the problem manually.</p>
<p>!!! Important
In such cases, please do not perform any manual operation without the
support and assistance of EDB engineering team.</p>
<p>From version 1.11.0 of the operator, you can use the
<code>cnpg.io/reconciliationLoop</code> annotation to temporarily disable the
reconciliation loop on a selected PostgreSQL cluster, as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example-no-reconcile</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cnpg.io/reconciliationLoop</span>: <span style="color:#e6db74">&#34;disabled&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># ...</span>
</span></span></code></pre></div><p>The <code>cnpg.io/reconciliationLoop</code> must be used with extreme care
and for the sole duration of the extraordinary/emergency operation.</p>
<p>!!! Warning
Please make sure that you use this annotation only for a limited period of
time and you remove it when the emergency has finished. Leaving this annotation
in a cluster will prevent the operator from issuing any self-healing operation,
such as a failover.</p>
</p>
    </div>
</div>


    <footer class="text-center pb-24">
    <p class="text-sm charcoal md:w-1/2 mx-auto md:pt-10 px-6 pt-12">&copy; 2019-2022 The CloudNativePG Contributors. All rights
        reserved. The Linux Foundation has registered trademarks and uses trademarks.
        For a list of trademarks of The Linux Foundation, please see our <a href="#" class="red-1">Trademark Usage
            page</a>.</p>
</footer>
  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>
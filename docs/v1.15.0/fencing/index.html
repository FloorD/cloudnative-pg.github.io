<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link rel="preload" href="/css/Supreme-Variable.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
  <link rel="favicon" href="/favicon/favicon.ico">
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="flex flex-row px-16 justify-between py-5">
      <div>
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      <div>
        <ul class="flex gap-14 text-2xl medium-gray my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Blog</li>
          <li><a href="/support">Support</a></li>
          <li><a href="/end_users">End Users</a></li>
        </ul>
      </div>
      <div class="flex gap-5 my-4 fill-cnp-blue">
       <a class="github-button" href="https://github.com/cloudnative-pg/cloudnative-pg"
            data-color-scheme="no-preference: light; light: light; dark: dark;"
            data-size="large" data-show-count="true"
            aria-label="Star cloudnative-pg/cloudnative-pg on GitHub">Star</a>
        <a href="https://join.slack.com/t/cloudnativepg/shared_invite/zt-17culux7k-P_UsVOOR9teUYi4dGhDSBQ">
          <img src="/icons/Slack.svg" alt="Slack" title="Join our Slack channel now!">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>


    
<base href="..">
<div class="px-56 pt-20 flex">
    <div class="w-1/4 px-5 bg-purple-2 pt-14 leading-9">
        
<ul>
    
    
    
    
    <li>
        <a href="/docs/v1.15.0/api_reference/">API Reference</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/applications/">Connecting from an application</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/architecture/">Architecture</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/backup_recovery/">Backup and Recovery</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/before_you_start/">Before You Start</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/bootstrap/">Bootstrap</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/certificates/">Certificates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/cnpg-plugin/">CloudNativePG Plugin</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/commercial_support/">Commercial support</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/connection_pooling/">Connection Pooling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/container_images/">Container Image Requirements</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/e2e/">End-to-End Tests</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/expose_pg_services/">Exposing Postgres Services</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failover/">Automated failover</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failure_modes/">Failure Modes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/fencing/">Fencing</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/installation_upgrade/">Installation and upgrades</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/instance_manager/">Postgres instance manager</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/kubernetes_upgrade/">Kubernetes Upgrade</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/labels_annotations/">Labels and annotations</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/logging/">Logging</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/monitoring/">Monitoring</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_capability_levels/">Operator Capability Levels</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_conf/">Operator configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/postgresql_conf/">PostgreSQL Configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/quickstart/">Quickstart</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/release_notes/">Release notes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/replication/">Replication</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/resource_management/">Resource management</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/rolling_update/">Rolling Updates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/samples/">Configuration Samples</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/scheduling/">Scheduling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/security/">Security</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/ssl_connections/">Client TLS/SSL Connections</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/storage/">Storage</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/supported_releases/">Supported releases</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/troubleshooting/">Troubleshooting</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/use_cases/">Use cases</a>
    </li>
    
    
    
</ul>

<hr class="w-1/2">


<p>Documention by version</p>
<ul>
    
    <li>
        <a href="/docs/v1.15.0/">
            CloudNativePG
            v1.15.0
        </a>
    </li>
    
</ul>

    </div>
    <div class="w-4/6 pr-20 ml-10 well">
        <p><h1 id="fencing">Fencing</h1>
<p>Fencing in CloudNativePG is the ultimate process of protecting the
data in one, more, or even all instances of a PostgreSQL cluster when they
appear to be malfunctioning. When an instance is fenced, the PostgreSQL server
process (<code>postmaster</code>) is guaranteed to be shut down, while the pod is kept running.
This makes sure that, until the fence is lifted, data on the pod is not modified by
PostgreSQL and that the file system can be investigated for debugging and
troubleshooting purposes.</p>
<h2 id="how-to-fence-instances">How to fence instances</h2>
<p>In CloudNativePG you can fence:</p>
<ul>
<li>a specific instance</li>
<li>a list of instances</li>
<li>an entire Postgres <code>Cluster</code></li>
</ul>
<p>Fencing is controlled through the content of the <code>cnpg.io/fencedInstances</code>
annotation, which expects a JSON formatted list of instance names.
If the annotation is set to <code>'[&quot;*&quot;]'</code>, a singleton list with a wildcard, the
whole cluster is fenced.
If the annotation is set to an empty JSON list, the operator behaves as if the
annotation was not set.</p>
<p>For example:</p>
<ul>
<li>
<p><code>cnpg.io/fencedInstances: '[&quot;cluster-example-1&quot;]'</code> will fence just
the <code>cluster-example-1</code> instance</p>
</li>
<li>
<p><code>cnpg.io/fencedInstances: '[&quot;cluster-example-1&quot;,&quot;cluster-example-2&quot;]'</code>
will fence the <code>cluster-example-1</code> and <code>cluster-example-2</code> instances</p>
</li>
<li>
<p><code>cnpg.io/fencedInstances: '[&quot;*&quot;]'</code> will fence every instance in
the cluster.</p>
</li>
</ul>
<p>The annotation can be manually set on the Kubernetes object, for example via
the <code>kubectl annotate</code> command, or in a transparent way using the
<code>kubectl cnpg fencing on</code> subcommand:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># to fence only one instance</span>
</span></span><span style="display:flex;"><span>kubectl cnpg fencing on cluster-example <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to fence all the instances in a Cluster</span>
</span></span><span style="display:flex;"><span>kubectl cnpg fencing on cluster-example <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><p>Here is an example of a <code>Cluster</code> with an instance that was previously fenced:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">cnpg.io/fencedInstances</span>: <span style="color:#e6db74">&#39;[&#34;cluster-example-1&#34;]&#39;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">...]</span>
</span></span></code></pre></div><h2 id="how-to-lift-fencing">How to lift fencing</h2>
<p>Fencing can be lifted by clearing the annotation, or set it to a different value.</p>
<p>As for fencing, this can be done either manually with <code>kubectl annotate</code>, or
using the <code>kubectl cnpg fencing</code> subcommand as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># to lift the fencing only for one instance</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># N.B.: at the moment this won&#39;t work if the whole cluster was fenced previously,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#       in that case you will have to manually set the annotation as explained above</span>
</span></span><span style="display:flex;"><span>kubectl cnpg fencing off cluster-example <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to lift the fencing for all the instances in a Cluster</span>
</span></span><span style="display:flex;"><span>kubectl cnpg fencing off cluster-example <span style="color:#e6db74">&#34;*&#34;</span>
</span></span></code></pre></div><h2 id="how-fencing-works">How fencing works</h2>
<p>Once an instance is set for fencing, the procedure to shut down the
<code>postmaster</code> process is initiated. This consists of an initial smart shutdown
with a timeout set to <code>.spec.stopDelay</code>, followed by a fast shutdown if
required. Then:</p>
<ul>
<li>
<p>the Pod will be kept alive</p>
</li>
<li>
<p>the Pod won&rsquo;t be marked as <em>Ready</em></p>
</li>
<li>
<p>all the changes that don&rsquo;t require the Postgres instance to be up will be
reconciled, including:</p>
<ul>
<li>configuration files</li>
<li>certificates and all the cryptographic material</li>
</ul>
</li>
<li>
<p>metrics will not be collected, except <code>cnpg_collector_fencing_on</code> which will be
set to 1</p>
</li>
</ul>
<p>!!! Warning
When at least one instance in a <code>Cluster</code> is fenced, failovers/switchovers for that
<code>Cluster</code> will be blocked until the fence is lifted, as the status of the <code>Cluster</code>
cannot be considered stable.</p>
<pre><code>In particular, if a **primary instance** will be fenced, the postmaster process
will be shut down but no failover will happen, interrupting the operativity of
the applications. When the fence will be lifted, the primary instance will be
started up again without any failover happening.

Given that, we advise the user to fence only replica instances when possible.
</code></pre>
<p>!!! Warning
If the primary is the only fenced instance in a <code>Cluster</code> and the pod is deleted, a
failover will be performed. When the fence on the old primary is lifted, that instance
is restarted as a standby (follower of the new primary).</p>
<p>If a fenced instance is deleted, the pod will be recreated normally, but the
postmaster won&rsquo;t be started. This can be extremely helpful when instances
are <code>Crashlooping</code>.</p>
</p>
    </div>
</div>


    <footer class="text-center pb-24">
    <p class="text-sm charcoal w-1/2 mx-auto pt-10">&copy; 2019-2022 The CloudNativePG Contributors. All rights
        reserved. The Linux Foundation has registered trademarks and uses trademarks.
        For a list of trademarks of The Linux Foundation, please see our <a href="#" class="red-1">Trademark Usage
            page</a>.</p>
</footer>
  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>

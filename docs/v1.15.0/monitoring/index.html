<!DOCTYPE html>




<html lang="en">

<head>
  <title>CloudNative PG</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication." />
  <meta name="keywords" content="" />
  <link rel="preload" href="/css/Supreme-Variable.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet" />
  <link href="/main.min.css" rel="stylesheet" />
  <link rel="favicon" href="/favicon/favicon.ico">
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>

<body>
  <div class="h-screen w-screen">
    
<main>
  <header>
    <div class="md:flex md:flex-row md:px-16 md:justify-between py-5">
      <div class="flex justify-between px-4 md:hidden">
        <div>
          
          <a href="/"><img src="/logo/large_logo.svg" class="md:h-14 h-9" alt="Cloud Native Postgres Logo"></a>
        </div>
        <div class="h-6 my-auto" id="toggle-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </div>
      </div>
      <div class="md:block hidden">
        
        <a href="/"><img src="/logo/large_logo.svg" class="h-14" alt="Cloud Native Postgres Logo"></a>
      </div>
      
      <div class="hidden md:block">
        <ul class="md:flex gap-14 text-2xl medium-gray my-5">
          <li><a href="/docs/1.15.0/" target="_blank">Documentation</a></li>
          <li>Blog</li>
          <li><a href="/support">Support</a></li>
          <li><a href="/end_users">End Users</a></li>
        </ul>
      </div>
      
      <div class="py-4 bg-gray-1 mt-5 hidden" id="navi-list">
        <ul class="md:flex gap-14 text-2xl md:medium-gray charcoal">
          <li class="text-center py-4"><a href="/docs">Documentation</a></li>
          <li class="text-center py-4"><a href="/blog">Blog</a></li>
          <li class="text-center py-4"><a href="/support">Support</a></li>
          <li class="text-center py-4"><a href="/end_users">End Users</a></li>
        </ul>
        <div class="flex gap-3 py-4 justify-center bg-gray-1 fill-cnp-blue">
          <a href="https://github.com/cloudnative-pg/cloudnative-pg">
            <img src="/icons/Git.svg" alt="Github">
          </a>
          <a href="https://cloudnativepg.slack.com/">
            <img src="/icons/Slack.svg" alt="Slack">
          </a>
          <a href="https://twitter.com/CloudNativePg">
            <img src="/icons/Twitter.svg" alt="Twitter">
          </a>
          <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
            <img src="/icons/YouTube.svg" alt="YouTube">
          </a>
        </div>
      </div>
      

      <div class="flex gap-5 my-4 fill-cnp-blue hidden md:flex">
       <a class="github-button" href="https://github.com/cloudnative-pg/cloudnative-pg"
            data-color-scheme="no-preference: light; light: light; dark: dark;"
            data-size="large" data-show-count="true"
            aria-label="Star cloudnative-pg/cloudnative-pg on GitHub">Star</a>
        <a href="https://join.slack.com/t/cloudnativepg/shared_invite/zt-17culux7k-P_UsVOOR9teUYi4dGhDSBQ">
          <img src="/icons/Slack.svg" alt="Slack" title="Join our Slack channel now!">
        </a>
        <a href="https://twitter.com/CloudNativePg">
          <img src="/icons/Twitter.svg" alt="Twitter">
        </a>
        <a href="https://www.youtube.com/channel/UCTGH88W1BiuRRPTzJUDPJyA">
          <img src="/icons/YouTube.svg" alt="YouTube">
        </a>
      </div>
    </div>
  </header>
</main>
<script>
  const toggleButton = document.getElementById('toggle-button')
  const naviList = document.getElementById('navi-list')

  toggleButton.addEventListener('click', () => {
    naviList.classList.toggle('hidden');
  })
</script>


    
<base href="..">
<div class="px-56 pt-20 flex">
    <div class="w-1/4 px-5 bg-purple-2 pt-14 leading-9">
        
<ul>
    
    
    
    
    <li>
        <a href="/docs/v1.15.0/api_reference/">API Reference</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/applications/">Connecting from an application</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/architecture/">Architecture</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/backup_recovery/">Backup and Recovery</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/before_you_start/">Before You Start</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/bootstrap/">Bootstrap</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/certificates/">Certificates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/cnpg-plugin/">CloudNativePG Plugin</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/commercial_support/">Commercial support</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/connection_pooling/">Connection Pooling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/container_images/">Container Image Requirements</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/e2e/">End-to-End Tests</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/expose_pg_services/">Exposing Postgres Services</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failover/">Automated failover</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/failure_modes/">Failure Modes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/fencing/">Fencing</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/installation_upgrade/">Installation and upgrades</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/instance_manager/">Postgres instance manager</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/kubernetes_upgrade/">Kubernetes Upgrade</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/labels_annotations/">Labels and annotations</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/logging/">Logging</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/monitoring/">Monitoring</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_capability_levels/">Operator Capability Levels</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/operator_conf/">Operator configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/postgresql_conf/">PostgreSQL Configuration</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/quickstart/">Quickstart</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/release_notes/">Release notes</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/replication/">Replication</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/resource_management/">Resource management</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/rolling_update/">Rolling Updates</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/samples/">Configuration Samples</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/scheduling/">Scheduling</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/security/">Security</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/ssl_connections/">Client TLS/SSL Connections</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/storage/">Storage</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/supported_releases/">Supported releases</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/troubleshooting/">Troubleshooting</a>
    </li>
    
    
    
    <li>
        <a href="/docs/v1.15.0/use_cases/">Use cases</a>
    </li>
    
    
    
</ul>

<hr class="w-1/2">


<p>Documention by version</p>
<ul>
    
    <li>
        <a href="/docs/v1.15.0/">
            CloudNativePG
            v1.15.0
        </a>
    </li>
    
</ul>

    </div>
    <div class="w-4/6 pr-20 ml-10 well">
        <p><h1 id="monitoring">Monitoring</h1>
<h2 id="monitoring-instances">Monitoring Instances</h2>
<p>For each PostgreSQL instance, the operator provides an exporter of metrics for
<a href="https://prometheus.io/">Prometheus</a> via HTTP, on port 9187, named <code>metrics</code>.
The operator comes with a <a href="#predefined-set-of-metrics">predefined set of metrics</a>, as well as a highly
configurable and customizable system to define additional queries via one or
more <code>ConfigMap</code> or <code>Secret</code> resources (see the
<a href="#user-defined-metrics">&ldquo;User defined metrics&rdquo; section</a> below for details).</p>
<p>!!! Important
Starting from version 1.11, CloudNativePG already installs
<a href="#default-set-of-metrics">by default a set of predefined metrics</a> in
a <code>ConfigMap</code> called <code>default-monitoring</code>.</p>
<p>Metrics can be accessed as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl http://&lt;pod_ip&gt;:9187/metrics
</span></span></code></pre></div><p>All monitoring queries that are performed on PostgreSQL are:</p>
<ul>
<li>transactionally atomic (one transaction per query)</li>
<li>executed with the <code>pg_monitor</code> role</li>
<li>executed with <code>application_name</code> set to <code>cnpg_metrics_exporter</code></li>
<li>executed as user <code>postgres</code></li>
</ul>
<p>Please refer to the &ldquo;Default roles&rdquo; section in PostgreSQL
<a href="https://www.postgresql.org/docs/current/default-roles.html">documentation</a>
for details on the <code>pg_monitor</code> role.</p>
<p>Queries, by default, are run against the <em>main database</em>, as defined by
the specified <code>bootstrap</code> method of the <code>Cluster</code> resource, according
to the following logic:</p>
<ul>
<li>using <code>initdb</code>: queries will be run against the specified database by default, so the
value passed as <code>initdb.database</code> or defaulting to <code>app</code> if not specified.</li>
<li>not using <code>initdb</code>: queries will run against the <code>postgres</code> database, by default.</li>
</ul>
<p>The default database can always be overridden for a given user-defined metric,
by specifying a list of one or more databases in the <code>target_databases</code> option.</p>
<p>!!! Seealso &ldquo;Prometheus/Grafana&rdquo;
If you are interested in evaluating the integration of CloudNativePG
with Prometheus and Grafana, please look at <a href="https://github.com/EnterpriseDB/cnp-sandbox">cnp-sandbox</a>.</p>
<h3 id="prometheus-operator-example">Prometheus Operator example</h3>
<p>A specific PostgreSQL cluster can be monitored using the
<a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator&rsquo;s</a> resource
<a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>.
A PodMonitor correctly pointing to a Cluster can be automatically created by the operator by setting
<code>.spec.monitoring.enablePodMonitor</code> to <code>true</code> in the Cluster resource itself (default: false).</p>
<p>!!! Important
Any change to the <code>PodMonitor</code> created automatically will be overridden by the Operator at the next reconciliation
cycle, in case you need to customize it, you can do so as described below.</p>
<p>To deploy a <code>PodMonitor</code> for a specific Cluster manually, you can just define it as follows, changing it as needed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodMonitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postgresql</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">metrics</span>
</span></span></code></pre></div><p>!!! Important
Make sure you modify the example above with a unique name as well as the
correct cluster&rsquo;s namespace and labels (we are using <code>cluster-example</code>).</p>
<h3 id="predefined-set-of-metrics">Predefined set of metrics</h3>
<p>Every PostgreSQL instance exporter automatically exposes a set of predefined
metrics, which can be classified in two major categories:</p>
<ul>
<li>
<p>PostgreSQL related metrics, starting with <code>cnpg_collector_*</code>, including:</p>
<ul>
<li>number of WAL files and total size on disk</li>
<li>number of <code>.ready</code> and <code>.done</code> files in the archive status folder</li>
<li>requested minimum and maximum number of synchronous replicas, as well as
the expected and actually observed values</li>
<li>flag indicating if replica cluster mode is enabled or disabled</li>
<li>flag indicating if a manual switchover is required</li>
</ul>
</li>
<li>
<p>Go runtime related metrics, starting with <code>go_*</code></p>
</li>
</ul>
<p>Below is a sample of the metrics returned by the <code>localhost:9187/metrics</code>
endpoint of an instance. As you can see, the Prometheus format is
self-documenting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># HELP cnpg_collector_collection_duration_seconds Collection time duration in seconds
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_collection_duration_seconds gauge
</span></span><span style="display:flex;"><span>cnpg_collector_collection_duration_seconds{collector=&#34;Collect.up&#34;} 0.0031393
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_collections_total Total number of times PostgreSQL was accessed for metrics.
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_collections_total counter
</span></span><span style="display:flex;"><span>cnpg_collector_collections_total 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_last_collection_error 1 if the last collection ended with error, 0 otherwise.
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_last_collection_error gauge
</span></span><span style="display:flex;"><span>cnpg_collector_last_collection_error 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_manual_switchover_required 1 if a manual switchover is required, 0 otherwise
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_manual_switchover_required gauge
</span></span><span style="display:flex;"><span>cnpg_collector_manual_switchover_required 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_pg_wal Total size in bytes of WAL segments in the &#39;/var/lib/postgresql/data/pgdata/pg_wal&#39; directory  computed as (wal_segment_size * count)
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_pg_wal gauge
</span></span><span style="display:flex;"><span>cnpg_collector_pg_wal{value=&#34;count&#34;} 7
</span></span><span style="display:flex;"><span>cnpg_collector_pg_wal{value=&#34;size&#34;} 1.17440512e+08
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_pg_wal_archive_status Number of WAL segments in the &#39;/var/lib/postgresql/data/pgdata/pg_wal/archive_status&#39; directory (ready, done)
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_pg_wal_archive_status gauge
</span></span><span style="display:flex;"><span>cnpg_collector_pg_wal_archive_status{value=&#34;done&#34;} 6
</span></span><span style="display:flex;"><span>cnpg_collector_pg_wal_archive_status{value=&#34;ready&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_replica_mode 1 if the cluster is in replica mode, 0 otherwise
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_replica_mode gauge
</span></span><span style="display:flex;"><span>cnpg_collector_replica_mode 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_sync_replicas Number of requested synchronous replicas (synchronous_standby_names)
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_sync_replicas gauge
</span></span><span style="display:flex;"><span>cnpg_collector_sync_replicas{value=&#34;expected&#34;} 0
</span></span><span style="display:flex;"><span>cnpg_collector_sync_replicas{value=&#34;max&#34;} 0
</span></span><span style="display:flex;"><span>cnpg_collector_sync_replicas{value=&#34;min&#34;} 0
</span></span><span style="display:flex;"><span>cnpg_collector_sync_replicas{value=&#34;observed&#34;} 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_up 1 if PostgreSQL is up, 0 otherwise.
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_up gauge
</span></span><span style="display:flex;"><span>cnpg_collector_up{cluster=&#34;cluster-example&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_postgres_version Postgres version
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_postgres_version gauge
</span></span><span style="display:flex;"><span>cnpg_collector_postgres_version{cluster=&#34;cluster-example&#34;,full=&#34;13.4.0&#34;} 13.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_first_recoverability_point The first point of recoverability for the cluster as a unix timestamp
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_first_recoverability_point gauge
</span></span><span style="display:flex;"><span>cnpg_collector_first_recoverability_point 1.63238406e+09
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP cnpg_collector_lo_pages Estimated number of pages in the pg_largeobject table
</span></span><span style="display:flex;"><span># TYPE cnpg_collector_lo_pages gauge
</span></span><span style="display:flex;"><span>cnpg_collector_lo_pages{datname=&#34;app&#34;} 0
</span></span><span style="display:flex;"><span>cnpg_collector_lo_pages{datname=&#34;postgres&#34;} 78
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
</span></span><span style="display:flex;"><span># TYPE go_gc_duration_seconds summary
</span></span><span style="display:flex;"><span>go_gc_duration_seconds{quantile=&#34;0&#34;} 5.01e-05
</span></span><span style="display:flex;"><span>go_gc_duration_seconds{quantile=&#34;0.25&#34;} 7.27e-05
</span></span><span style="display:flex;"><span>go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0.0001748
</span></span><span style="display:flex;"><span>go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.0002959
</span></span><span style="display:flex;"><span>go_gc_duration_seconds{quantile=&#34;1&#34;} 0.0012776
</span></span><span style="display:flex;"><span>go_gc_duration_seconds_sum 0.0035741
</span></span><span style="display:flex;"><span>go_gc_duration_seconds_count 13
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_goroutines Number of goroutines that currently exist.
</span></span><span style="display:flex;"><span># TYPE go_goroutines gauge
</span></span><span style="display:flex;"><span>go_goroutines 25
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_info Information about the Go environment.
</span></span><span style="display:flex;"><span># TYPE go_info gauge
</span></span><span style="display:flex;"><span>go_info{version=&#34;go1.17.1&#34;} 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.
</span></span><span style="display:flex;"><span># TYPE go_memstats_alloc_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_alloc_bytes 4.493744e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.
</span></span><span style="display:flex;"><span># TYPE go_memstats_alloc_bytes_total counter
</span></span><span style="display:flex;"><span>go_memstats_alloc_bytes_total 2.1698216e+07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_buck_hash_sys_bytes Number of bytes used by the profiling bucket hash table.
</span></span><span style="display:flex;"><span># TYPE go_memstats_buck_hash_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_buck_hash_sys_bytes 1.456234e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_frees_total Total number of frees.
</span></span><span style="display:flex;"><span># TYPE go_memstats_frees_total counter
</span></span><span style="display:flex;"><span>go_memstats_frees_total 172118
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_gc_cpu_fraction The fraction of this program&#39;s available CPU time used by the GC since the program started.
</span></span><span style="display:flex;"><span># TYPE go_memstats_gc_cpu_fraction gauge
</span></span><span style="display:flex;"><span>go_memstats_gc_cpu_fraction 1.0749468700447189e-05
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_gc_sys_bytes Number of bytes used for garbage collection system metadata.
</span></span><span style="display:flex;"><span># TYPE go_memstats_gc_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_gc_sys_bytes 5.530048e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_alloc_bytes Number of heap bytes allocated and still in use.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_alloc_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_alloc_bytes 4.493744e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_idle_bytes Number of heap bytes waiting to be used.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_idle_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_idle_bytes 5.8236928e+07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_inuse_bytes Number of heap bytes that are in use.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_inuse_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_inuse_bytes 7.528448e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_objects Number of allocated objects.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_objects gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_objects 26306
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_released_bytes Number of heap bytes released to OS.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_released_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_released_bytes 5.7401344e+07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_heap_sys_bytes Number of heap bytes obtained from system.
</span></span><span style="display:flex;"><span># TYPE go_memstats_heap_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_heap_sys_bytes 6.5765376e+07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_last_gc_time_seconds Number of seconds since 1970 of last garbage collection.
</span></span><span style="display:flex;"><span># TYPE go_memstats_last_gc_time_seconds gauge
</span></span><span style="display:flex;"><span>go_memstats_last_gc_time_seconds 1.6311727586032727e+09
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_lookups_total Total number of pointer lookups.
</span></span><span style="display:flex;"><span># TYPE go_memstats_lookups_total counter
</span></span><span style="display:flex;"><span>go_memstats_lookups_total 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_mallocs_total Total number of mallocs.
</span></span><span style="display:flex;"><span># TYPE go_memstats_mallocs_total counter
</span></span><span style="display:flex;"><span>go_memstats_mallocs_total 198424
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_mcache_inuse_bytes Number of bytes in use by mcache structures.
</span></span><span style="display:flex;"><span># TYPE go_memstats_mcache_inuse_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_mcache_inuse_bytes 14400
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_mcache_sys_bytes Number of bytes used for mcache structures obtained from system.
</span></span><span style="display:flex;"><span># TYPE go_memstats_mcache_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_mcache_sys_bytes 16384
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_mspan_inuse_bytes Number of bytes in use by mspan structures.
</span></span><span style="display:flex;"><span># TYPE go_memstats_mspan_inuse_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_mspan_inuse_bytes 191896
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system.
</span></span><span style="display:flex;"><span># TYPE go_memstats_mspan_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_mspan_sys_bytes 212992
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_next_gc_bytes Number of heap bytes when next garbage collection will take place.
</span></span><span style="display:flex;"><span># TYPE go_memstats_next_gc_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_next_gc_bytes 8.689632e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_other_sys_bytes Number of bytes used for other system allocations.
</span></span><span style="display:flex;"><span># TYPE go_memstats_other_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_other_sys_bytes 2.566622e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_stack_inuse_bytes Number of bytes in use by the stack allocator.
</span></span><span style="display:flex;"><span># TYPE go_memstats_stack_inuse_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_stack_inuse_bytes 1.343488e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_stack_sys_bytes Number of bytes obtained from system for stack allocator.
</span></span><span style="display:flex;"><span># TYPE go_memstats_stack_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_stack_sys_bytes 1.343488e+06
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_memstats_sys_bytes Number of bytes obtained from system.
</span></span><span style="display:flex;"><span># TYPE go_memstats_sys_bytes gauge
</span></span><span style="display:flex;"><span>go_memstats_sys_bytes 7.6891144e+07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># HELP go_threads Number of OS threads created.
</span></span><span style="display:flex;"><span># TYPE go_threads gauge
</span></span><span style="display:flex;"><span>go_threads 18
</span></span></code></pre></div><p>!!! Note
<code>cnpg_collector_postgres_version</code> is a GaugeVec metric containing
the <code>Major.Minor</code> version of PostgreSQL. The full semantic version
<code>Major.Minor.Patch</code> can be found inside one of its label field
named <code>full</code>.</p>
<h3 id="user-defined-metrics">User defined metrics</h3>
<p>This feature is currently in <em>beta</em> state and the format is inspired by the
<a href="https://github.com/prometheus-community/postgres_exporter/blob/master/queries.yaml">queries.yaml file</a> <!-- raw HTML omitted -->
of the PostgreSQL Prometheus Exporter.</p>
<p>Custom metrics can be defined by users by referring to the created <code>Configmap</code>/<code>Secret</code> in a <code>Cluster</code> definition
under the <code>.spec.monitoring.customQueriesConfigMap</code> or <code>customQueriesSecret</code> section as in the following example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">postgresql.cnpg.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Cluster</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cluster-example</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">instances</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storage</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">size</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">monitoring</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">customQueriesConfigMap</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-monitoring</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">key</span>: <span style="color:#ae81ff">custom-queries</span>
</span></span></code></pre></div><p>The <code>customQueriesConfigMap</code>/<code>customQueriesSecret</code> sections contain a list of
<code>ConfigMap</code>/<code>Secret</code> references specifying the key in which the custom queries are defined.
Take care that the referred resources have to be created <strong>in the same namespace as the Cluster</strong> resource.</p>
<p>!!! Note
If you want ConfigMaps and Secrets to be <strong>automatically</strong> reloaded by instances, you can
add a label with key <code>cnpg.io/reload</code> to it, otherwise you will have to reload
the instances using the <code>kubectl cnpg reload</code> subcommand.</p>
<p>!!! Important
When a user defined metric overwrites an already existing metric the instance manager prints a json warning log,
containing the message:<code>Query with the same name already found. Overwriting the existing one.</code>
and a key <code>queryName</code> containing the overwritten query name.</p>
<h4 id="example-of-a-user-defined-metric">Example of a user defined metric</h4>
<p>Here you can see an example of a <code>ConfigMap</code> containing a single custom query,
referenced by the <code>Cluster</code> example above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">test</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cnpg.io/reload</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">custom-queries</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    pg_replication:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      query: &#34;SELECT CASE WHEN NOT pg_is_in_recovery()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              THEN 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              ELSE GREATEST (0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              END AS lag,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              pg_is_in_recovery() AS in_recovery,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              EXISTS (TABLE pg_stat_wal_receiver) AS is_wal_receiver_up,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">              (SELECT count(*) FROM pg_stat_replication) AS streaming_replicas&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      metrics:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - lag:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            usage: &#34;GAUGE&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            description: &#34;Replication lag behind primary in seconds&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - in_recovery:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            usage: &#34;GAUGE&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            description: &#34;Whether the instance is in recovery&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - is_wal_receiver_up:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            usage: &#34;GAUGE&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            description: &#34;Whether the instance wal_receiver is up&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - streaming_replicas:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            usage: &#34;GAUGE&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            description: &#34;Number of streaming replicas connected to the instance&#34;</span>    
</span></span></code></pre></div><p>A list of basic monitoring queries can be found in the <a href="./samples/cnpg-basic-monitoring.yaml"><code>cnpg-basic-monitoring.yaml</code> file</a>.</p>
<h4 id="example-of-a-user-defined-metric-running-on-multiple-databases">Example of a user defined metric running on multiple databases</h4>
<p>If the <code>target_databases</code> option lists more than one database
the metric is collected from each of them.</p>
<p>Database auto-discovery can be enabled for a specific query by specifying a
<em>shell-like pattern</em> (i.e., containing <code>*</code>, <code>?</code> or <code>[]</code>) in the list of
<code>target_databases</code>. If provided, the operator will expand the list of target
databases by adding all the databases returned by the execution of <code>SELECT datname FROM pg_database WHERE datallowconn AND NOT datistemplate</code> and matching
the pattern according to <a href="https://pkg.go.dev/path#Match">path.Match()</a> rules.</p>
<p>!!! Note
The <code>*</code> character has a <a href="https://yaml.org/spec/1.2/spec.html#id2786448">special meaning</a> in yaml,
so you need to quote (<code>&quot;*&quot;</code>) the <code>target_databases</code> value when it includes such a pattern.</p>
<p>It is recommended that you always include the name of the database
in the returned labels, for example using the <code>current_database()</code> function
as in the following example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">some_query</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     current_database() as datname,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     count(*) as rows
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FROM some_table</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">datname</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">usage</span>: <span style="color:#e6db74">&#34;LABEL&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Name of current database&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">rows</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">usage</span>: <span style="color:#e6db74">&#34;GAUGE&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;number of rows&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_databases</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">albert</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">bb</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">freddie</span>
</span></span></code></pre></div><p>This will produce in the following metric being exposed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;albert&#34;} 2
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;bb&#34;} 5
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;freddie&#34;} 10
</span></span></code></pre></div><p>Here is an example of a query with auto-discovery enabled which also
runs on the <code>template1</code> database (otherwise not returned by the
aforementioned query):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">some_query</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">query</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     current_database() as datname,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     count(*) as rows
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FROM some_table</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">datname</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">usage</span>: <span style="color:#e6db74">&#34;LABEL&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Name of current database&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">rows</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">usage</span>: <span style="color:#e6db74">&#34;GAUGE&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;number of rows&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">target_databases</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;template1&#34;</span>
</span></span></code></pre></div><p>The above example will produce the following metrics (provided the databases exist):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;albert&#34;} 2
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;bb&#34;} 5
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;freddie&#34;} 10
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;template1&#34;} 7
</span></span><span style="display:flex;"><span>cnpg_some_query_rows{datname=&#34;postgres&#34;} 42
</span></span></code></pre></div><h3 id="structure-of-a-user-defined-metric">Structure of a user defined metric</h3>
<p>Every custom query has the following basic structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">&lt;MetricName&gt;</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">query</span>: <span style="color:#e6db74">&#34;&lt;SQLQuery&gt;&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">metrics</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">&lt;ColumnName&gt;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">usage</span>: <span style="color:#e6db74">&#34;&lt;MetricType&gt;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;&lt;MetricDescription&gt;&#34;</span>
</span></span></code></pre></div><p>Here is a short description of all the available fields:</p>
<ul>
<li><code>&lt;MetricName&gt;</code>: the name of the Prometheus metric
<ul>
<li><code>query</code>: the SQL query to run on the target database to generate the metrics</li>
<li><code>primary</code>: whether to run the query only on the primary instance <!-- raw HTML omitted --></li>
<li><code>master</code>: same as <code>primary</code> (for compatibility with the Prometheus PostgreSQL exporter&rsquo;s syntax - deprecated) <!-- raw HTML omitted --></li>
<li><code>runonserver</code>: a semantic version range to limit the versions of PostgreSQL the query should run on
(e.g. <code>&quot;&gt;=10.0.0&quot;</code> or <code>&quot;&gt;=12.0.0 &lt;=14.2.0&quot;</code>)</li>
<li><code>target_databases</code>: a list of databases to run the <code>query</code> against,
or a <a href="#example-of-a-user-defined-metric-running-on-multiple-databases">shell-like pattern</a>
to enable auto discovery. Overwrites the default database if provided.</li>
<li><code>metrics</code>: section containing a list of all exported columns, defined as follows:
<ul>
<li><code>&lt;ColumnName&gt;</code>: the name of the column returned by the query
<ul>
<li><code>usage</code>: one of the values described below</li>
<li><code>description</code>: the metric&rsquo;s description</li>
<li><code>metrics_mapping</code>: the optional column mapping when <code>usage</code> is set to <code>MAPPEDMETRIC</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The possible values for <code>usage</code> are:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Column Usage Label</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>DISCARD</code></td>
<td style="text-align:left">this column should be ignored</td>
</tr>
<tr>
<td style="text-align:left"><code>LABEL</code></td>
<td style="text-align:left">use this column as a label</td>
</tr>
<tr>
<td style="text-align:left"><code>COUNTER</code></td>
<td style="text-align:left">use this column as a counter</td>
</tr>
<tr>
<td style="text-align:left"><code>GAUGE</code></td>
<td style="text-align:left">use this column as a gauge</td>
</tr>
<tr>
<td style="text-align:left"><code>MAPPEDMETRIC</code></td>
<td style="text-align:left">use this column with the supplied mapping of text values</td>
</tr>
<tr>
<td style="text-align:left"><code>DURATION</code></td>
<td style="text-align:left">use this column as a text duration (in milliseconds)</td>
</tr>
<tr>
<td style="text-align:left"><code>HISTOGRAM</code></td>
<td style="text-align:left">use this column as a histogram</td>
</tr>
</tbody>
</table>
<p>Please visit the <a href="https://prometheus.io/docs/concepts/metric_types/">&ldquo;Metric Types&rdquo; page</a>
from the Prometheus documentation for more information.</p>
<h3 id="output-of-a-user-defined-metric">Output of a user defined metric</h3>
<p>Custom defined metrics are returned by the Prometheus exporter endpoint (<code>:9187/metrics</code>)
with the following format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cnpg_&lt;MetricName&gt;_&lt;ColumnName&gt;{&lt;LabelColumnName&gt;=&lt;LabelColumnValue&gt; ... } &lt;ColumnValue&gt;
</span></span></code></pre></div><p>!!! Note
<code>LabelColumnName</code> are metrics with <code>usage</code> set to <code>LABEL</code> and their <code>Value</code></p>
<p>Considering the <code>pg_replication</code> example above, the exporter&rsquo;s endpoint would
return the following output when invoked:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># HELP cnpg_pg_replication_in_recovery Whether the instance is in recovery
</span></span><span style="display:flex;"><span># TYPE cnpg_pg_replication_in_recovery gauge
</span></span><span style="display:flex;"><span>cnpg_pg_replication_in_recovery 0
</span></span><span style="display:flex;"><span># HELP cnpg_pg_replication_lag Replication lag behind primary in seconds
</span></span><span style="display:flex;"><span># TYPE cnpg_pg_replication_lag gauge
</span></span><span style="display:flex;"><span>cnpg_pg_replication_lag 0
</span></span><span style="display:flex;"><span># HELP cnpg_pg_replication_streaming_replicas Number of streaming replicas connected to the instance
</span></span><span style="display:flex;"><span># TYPE cnpg_pg_replication_streaming_replicas gauge
</span></span><span style="display:flex;"><span>cnpg_pg_replication_streaming_replicas 2
</span></span><span style="display:flex;"><span># HELP cnpg_pg_replication_is_wal_receiver_up Whether the instance wal_receiver is up
</span></span><span style="display:flex;"><span># TYPE cnpg_pg_replication_is_wal_receiver_up gauge
</span></span><span style="display:flex;"><span>cnpg_pg_replication_is_wal_receiver_up 0
</span></span></code></pre></div><h3 id="default-set-of-metrics">Default set of metrics</h3>
<p>The operator can be configured to automatically inject in a Cluster a set of
monitoring queries defined in a ConfigMap or a Secret, inside the operator&rsquo;s namespace.
You have to set the <code>MONITORING_QUERIES_CONFIGMAP</code> or
<code>MONITORING_QUERIES_SECRET</code> key in the <a href="operator_conf.md">&ldquo;operator configuration&rdquo;</a>,
respectively to the name of the ConfigMap or the Secret;
the operator will then use the content of the <code>queries</code> key.</p>
<p>Any change to the <code>queries</code> content will be immediately reflected on all the
deployed Clusters using it.</p>
<p>The operator installation manifests come with a predefined ConfigMap,
called <code>cnpg-default-monitoring</code>, to be used by all Clusters.
<code>MONITORING_QUERIES_CONFIGMAP</code> is by default set to <code>cnpg-default-monitoring</code> in the operator configuration.</p>
<p>If you want to disable the default set of metrics, you can:</p>
<ul>
<li>disable it at operator level: set the <code>MONITORING_QUERIES_CONFIGMAP</code>/<code>MONITORING_QUERIES_SECRET</code> key to <code>&quot;&quot;</code>
(empty string), in the operator ConfigMap. Changes to operator ConfigMap require an operator restart.</li>
<li>disable it for a specific Cluster: set <code>.spec.monitoring.disableDefaultQueries</code> to <code>true</code> in the Cluster.</li>
</ul>
<p>!!! Important
The ConfigMap or Secret specified via <code>MONITORING_QUERIES_CONFIGMAP</code>/<code>MONITORING_QUERIES_SECRET</code>
will always be copied to the Cluster&rsquo;s namespace with a fixed name: <code>cnpg-default-monitoring</code>.
So that, if you intend to have default metrics, you should not create a ConfigMap with this name in the cluster&rsquo;s namespace.</p>
<h3 id="differences-with-the-prometheus-postgres-exporter">Differences with the Prometheus Postgres exporter</h3>
<p>CloudNativePG is inspired by the PostgreSQL Prometheus Exporter, but
presents some differences. In particular, the <code>cache_seconds</code> field is not implemented
in CloudNativePG&rsquo;s exporter.</p>
<h2 id="monitoring-the-operator">Monitoring the operator</h2>
<p>The operator internally exposes <a href="https://prometheus.io/">Prometheus</a> metrics
via HTTP on port 8080, named <code>metrics</code>.</p>
<p>Metrics can be accessed as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl http://&lt;pod_ip&gt;:8080/metrics
</span></span></code></pre></div><p>Currently, the operator exposes default <code>kubebuilder</code> metrics, see
<a href="https://book.kubebuilder.io/reference/metrics.html">kubebuilder documentation</a> for more details.</p>
<h3 id="prometheus-operator-example-1">Prometheus Operator example</h3>
<p>The operator deployment can be monitored using the
<a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a> by defining the following
<a href="https://github.com/prometheus-operator/prometheus-operator/blob/v0.47.1/Documentation/api.md#podmonitor">PodMonitor</a>
resource:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodMonitor</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cnpg-controller-manager</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">cloudnative-pg</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podMetricsEndpoints</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">metrics</span>
</span></span></code></pre></div></p>
    </div>
</div>


    <footer class="text-center pb-24">
    <p class="text-sm charcoal md:w-1/2 mx-auto md:pt-10 px-6 pt-12">&copy; 2019-2022 The CloudNativePG Contributors. All rights
        reserved. The Linux Foundation has registered trademarks and uses trademarks.
        For a list of trademarks of The Linux Foundation, please see our <a href="#" class="red-1">Trademark Usage
            page</a>.</p>
</footer>
  </div>
  
  <script src="https://cdn.usefathom.com/script.js" data-site="GSMQCVAJ" defer></script>
  
</body>

</html>